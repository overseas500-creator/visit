{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MJD8/OneDrive/Desktop/projects/visit/src/app/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { db } from '@/lib/db';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\nexport async function sendOTP(mobileNumber: string) {\r\n    // 1. Generate 4-digit code\r\n    const code = Math.floor(1000 + Math.random() * 9000).toString();\r\n\r\n    // 2. Save to DB with expiration (5 mins)\r\n    const expiresAt = new Date(Date.now() + 5 * 60 * 1000).toISOString();\r\n\r\n    if (process.env.NEXT_PHASE !== 'phase-production-build') {\r\n        const stmt = db.prepare(`\r\n        INSERT OR REPLACE INTO otp_codes (mobile_number, code, expires_at)\r\n        VALUES (?, ?, ?)\r\n      `);\r\n        stmt.run(mobileNumber, code, expiresAt);\r\n    }\r\n\r\n    // 3. Send SMS\r\n    try {\r\n        // Fetch SMS settings from DB\r\n        const settingsStmt = db.prepare(\"SELECT key, value FROM settings WHERE key IN ('sms_api_key', 'sms_sender_name')\");\r\n        const settings = settingsStmt.all() as { key: string; value: string }[];\r\n        const settingsMap = settings.reduce((acc, curr) => ({ ...acc, [curr.key]: curr.value }), {} as Record<string, string>);\r\n\r\n        const apiKey = settingsMap['sms_api_key'] || 'Cg4W16D1N9ckkBXhUafP0gS19XB6ZujmMNC5rtkt1e2e6f1c';\r\n        const senderName = settingsMap['sms_sender_name'] || 'School1';\r\n\r\n        const message = `رمز التحقق: ${code}`;\r\n\r\n        // Format number: remove leading 0, prefix with 966\r\n        // 0501234567 -> 966501234567\r\n        let number = mobileNumber.trim();\r\n        if (number.startsWith('0')) {\r\n            number = '966' + number.substring(1);\r\n        } else if (number.startsWith('5')) {\r\n            number = '966' + number;\r\n        }\r\n\r\n        console.log(`[SMS] Sending to ${number}...`);\r\n\r\n        const response = await fetch('https://app.mobile.net.sa/api/v1/send', {\r\n            method: 'POST',\r\n            headers: {\r\n                'Authorization': `Bearer ${apiKey}`,\r\n                'Content-Type': 'application/json',\r\n                'Accept': 'application/json'\r\n            },\r\n            body: JSON.stringify({\r\n                number: number,\r\n                senderName: senderName, // Using default/example sender name to ensure delivery\r\n                sendAtOption: \"Now\",\r\n                messageBody: message,\r\n                allow_duplicate: true\r\n            })\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            console.error('SMS API Error:', errorText);\r\n            // Try to parse JSON error if possible\r\n            try {\r\n                const jsonError = JSON.parse(errorText);\r\n                return { success: false, error: `فشل المزود: ${jsonError.message || JSON.stringify(jsonError)}` };\r\n            } catch {\r\n                return { success: false, error: `فشل المزود: ${errorText.substring(0, 100)}` };\r\n            }\r\n        }\r\n\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Failed to send SMS:', error);\r\n        return { success: false, error: `فشل إرسال الرسالة: ${error.message}` };\r\n    }\r\n}\r\n\r\nexport async function verifyOTP(mobileNumber: string, code: string) {\r\n    const stmt = db.prepare('SELECT code, expires_at FROM otp_codes WHERE mobile_number = ?');\r\n    const result = stmt.get(mobileNumber) as { code: string; expires_at: string };\r\n\r\n    if (!result) return { success: false, error: 'رقم الجوال غير معروف' };\r\n\r\n    if (result.code !== code) return { success: false, error: 'رمز التحقق غير صحيح' };\r\n\r\n    if (new Date(result.expires_at) < new Date()) {\r\n        return { success: false, error: 'انتهت صلاحية الرمز' };\r\n    }\r\n\r\n    // Clear OTP after success\r\n    db.prepare('DELETE FROM otp_codes WHERE mobile_number = ?').run(mobileNumber);\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport interface VisitorData {\r\n    name: string;\r\n    idNumber: string;\r\n    mobileNumber: string;\r\n    purpose: string;\r\n    signature: string; // Base64\r\n}\r\n\r\nexport async function submitVisitor(data: VisitorData) {\r\n    const stmt = db.prepare(`\r\n    INSERT INTO visitors (name, id_number, mobile_number, visit_date, visit_time, purpose, signature)\r\n    VALUES (?, ?, ?, ?, ?, ?, ?)\r\n  `);\r\n\r\n    const now = new Date();\r\n    const date = now.toISOString().split('T')[0]; // YYYY-MM-DD\r\n    const time = now.toLocaleTimeString('en-US', { hour12: false });\r\n\r\n    try {\r\n        const result = stmt.run(\r\n            data.name,\r\n            data.idNumber,\r\n            data.mobileNumber,\r\n            date,\r\n            time,\r\n            data.purpose,\r\n            data.signature\r\n        );\r\n\r\n        revalidatePath('/');\r\n        return { success: true, id: result.lastInsertRowid };\r\n    } catch (error) {\r\n        console.error('Failed to save visitor:', error);\r\n        return { success: false, error: 'Failed to save data' };\r\n    }\r\n}\r\n\r\nexport async function getVisitors(date?: string) {\r\n    // If no date provided, default to today's date\r\n    const targetDate = date || new Date().toISOString().split('T')[0];\r\n\r\n    try {\r\n        const stmt = db.prepare('SELECT * FROM visitors WHERE visit_date = ? ORDER BY id DESC');\r\n        const visitors = stmt.all(targetDate) as any[]; // Type as needed\r\n        return { success: true, data: visitors };\r\n    } catch (error) {\r\n        console.error('Failed to get visitors:', error);\r\n        return { success: false, error: 'Failed to fetch data' };\r\n    }\r\n}\r\n\r\nexport async function getSchoolInfo() {\r\n    try {\r\n        const keys = ['school_country', 'school_ministry', 'school_directorate', 'school_name', 'sms_api_key', 'sms_sender_name', 'enable_otp'];\r\n        const placeholders = keys.map(() => '?').join(',');\r\n        const stmt = db.prepare(`SELECT key, value FROM settings WHERE key IN (${placeholders})`);\r\n        const results = stmt.all(...keys) as { key: string; value: string }[];\r\n\r\n        const info: Record<string, string> = {};\r\n        results.forEach(r => {\r\n            info[r.key] = r.value;\r\n        });\r\n\r\n        return { success: true, data: info };\r\n    } catch (error) {\r\n        console.error('Failed to get school info:', error);\r\n        return { success: false, error: 'Failed to fetch info' };\r\n    }\r\n}\r\n\r\n// Existing import modification\r\nimport * as XLSX from 'xlsx';\r\n\r\n// ... (keep existing functions, I will just append new ones for now, but better to do it cleanly)\r\n\r\nexport async function importStudents(formData: FormData) {\r\n    const file = formData.get('file') as File;\r\n    if (!file) return { success: false, error: 'No file uploaded' };\r\n\r\n    try {\r\n        const bytes = await file.arrayBuffer();\r\n        const buffer = Buffer.from(bytes);\r\n        const workbook = XLSX.read(buffer, { type: 'buffer' });\r\n        const sheetName = workbook.SheetNames[0];\r\n        const sheet = workbook.Sheets[sheetName];\r\n        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });\r\n\r\n        // Expected columns: Name, Grade, Class, ID Number, Mobile\r\n        // Assuming header row exists, start from index 1. If not, check data.\r\n        // Let's assume row 0 is header.\r\n\r\n        const stmt = db.prepare(`\r\n            INSERT INTO students (name, grade, class_name, id_number, mobile_number)\r\n            VALUES (?, ?, ?, ?, ?)\r\n        `);\r\n\r\n        // Use transaction for bulk insert\r\n        const insertMany = db.transaction((rows) => {\r\n            for (const row of rows) {\r\n                // row is array [Name, Grade, Class, ID, Mobile]\r\n                // Be careful with index if header exists\r\n                if (!row[0] || !row[3]) continue; // Skip empty rows or missing mandatory fields\r\n                try {\r\n                    stmt.run(row[0], row[1], row[2], String(row[3]), String(row[4]));\r\n                } catch (e) {\r\n                    console.log('Skipping duplicate or invalid row:', row);\r\n                }\r\n            }\r\n        });\r\n\r\n        // Skip first row (headers)\r\n        const dataRows = jsonData.slice(1);\r\n        insertMany(dataRows);\r\n\r\n        return { success: true, count: dataRows.length };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Failed to process file' };\r\n    }\r\n}\r\n\r\n// ... (existing code)\r\n\r\nexport async function getAllStudents() {\r\n    try {\r\n        const stmt = db.prepare('SELECT * FROM students ORDER BY grade, class_name, name');\r\n        const students = stmt.all();\r\n        return { success: true, data: students };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Failed to fetch students' };\r\n    }\r\n}\r\n\r\nexport async function searchStudents(filters: { name?: string, grade?: string, class_name?: string, id_number?: string, mobile_number?: string }) {\r\n    try {\r\n        let sql = 'SELECT * FROM students WHERE 1=1';\r\n        const params: any[] = [];\r\n\r\n        if (filters.name?.trim()) {\r\n            sql += ' AND name LIKE ?';\r\n            params.push(`%${filters.name.trim()}%`);\r\n        }\r\n        if (filters.grade?.trim()) {\r\n            sql += ' AND grade LIKE ?';\r\n            params.push(`%${filters.grade.trim()}%`);\r\n        }\r\n        if (filters.class_name?.trim()) {\r\n            sql += ' AND class_name LIKE ?';\r\n            params.push(`%${filters.class_name.trim()}%`);\r\n        }\r\n        if (filters.id_number?.trim()) {\r\n            sql += ' AND id_number LIKE ?';\r\n            params.push(`%${filters.id_number.trim()}%`);\r\n        }\r\n        if (filters.mobile_number?.trim()) {\r\n            sql += ' AND mobile_number LIKE ?';\r\n            params.push(`%${filters.mobile_number.trim()}%`);\r\n        }\r\n\r\n        sql += ' LIMIT 20';\r\n\r\n        const stmt = db.prepare(sql);\r\n        const students = stmt.all(...params);\r\n        return { success: true, data: students };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Search failed' };\r\n    }\r\n}\r\n\r\nexport async function createExitPermit(studentId: number, reason: string, authorizer: string) {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            INSERT INTO student_exits (student_id, reason, authorizer)\r\n            VALUES (?, ?, ?)\r\n        `);\r\n        stmt.run(studentId, reason, authorizer);\r\n        revalidatePath('/admin/exit-permit');\r\n        revalidatePath('/guard');\r\n        return { success: true };\r\n    } catch (e) {\r\n        return { success: false, error: 'Failed to create permit' };\r\n    }\r\n}\r\n\r\nexport async function getExitPermits(status = 'PENDING') {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            SELECT e.*, s.name as student_name, s.grade, s.class_name \r\n            FROM student_exits e\r\n            JOIN students s ON e.student_id = s.id\r\n            WHERE e.status = ?\r\n            ORDER BY e.request_time DESC\r\n        `);\r\n        const permits = stmt.all(status);\r\n        return { success: true, data: permits };\r\n    } catch (e) {\r\n        return { success: false, error: 'Fetch failed' };\r\n    }\r\n}\r\n\r\nexport async function confirmExitPermit(id: number) {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            UPDATE student_exits \r\n            SET status = 'EXITED', exit_time = CURRENT_TIMESTAMP\r\n            WHERE id = ?\r\n        `);\r\n        const info = stmt.run(id);\r\n        console.log('Confirm Permit ID:', id, 'Changes:', info.changes);\r\n        if (info.changes === 0) return { success: false, error: 'Permit not found' };\r\n        revalidatePath('/guard');\r\n        revalidatePath('/admin/exit-permit');\r\n        return { success: true };\r\n    } catch (e) {\r\n        return { success: false, error: 'Update failed' };\r\n    }\r\n}\r\n\r\nexport async function getStudentExitReport(date?: string) {\r\n    const targetDate = date || new Date().toISOString().split('T')[0];\r\n    try {\r\n        // Get exits for the day\r\n        const stmt = db.prepare(`\r\n            SELECT e.*, s.name, s.grade, s.class_name, s.id_number\r\n            FROM student_exits e\r\n            JOIN students s ON e.student_id = s.id\r\n            WHERE date(e.exit_time) = ? AND e.status = 'EXITED'\r\n            ORDER BY e.exit_time DESC\r\n        `);\r\n\r\n        const exits = stmt.all(targetDate) as any[];\r\n\r\n        // Calculate cumulative count for each student in the list\r\n        // Could be optimized, but simpler to query individually or group by\r\n\r\n        const exitsWithCount = await Promise.all(exits.map(async (exit) => {\r\n            const countStmt = db.prepare(`\r\n                SELECT COUNT(*) as count FROM student_exits \r\n                WHERE student_id = ? AND status = 'EXITED'\r\n            `);\r\n            const countRes = countStmt.get(exit.student_id) as { count: number };\r\n            return { ...exit, cumulative_count: countRes.count };\r\n        }));\r\n\r\n        return { success: true, data: exitsWithCount };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Report failed' };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MAqIsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,+CAAA"}},
    {"offset": {"line": 21, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MJD8/OneDrive/Desktop/projects/visit/src/app/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { db } from '@/lib/db';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\nexport async function sendOTP(mobileNumber: string) {\r\n    // 1. Generate 4-digit code\r\n    const code = Math.floor(1000 + Math.random() * 9000).toString();\r\n\r\n    // 2. Save to DB with expiration (5 mins)\r\n    const expiresAt = new Date(Date.now() + 5 * 60 * 1000).toISOString();\r\n\r\n    if (process.env.NEXT_PHASE !== 'phase-production-build') {\r\n        const stmt = db.prepare(`\r\n        INSERT OR REPLACE INTO otp_codes (mobile_number, code, expires_at)\r\n        VALUES (?, ?, ?)\r\n      `);\r\n        stmt.run(mobileNumber, code, expiresAt);\r\n    }\r\n\r\n    // 3. Send SMS\r\n    try {\r\n        // Fetch SMS settings from DB\r\n        const settingsStmt = db.prepare(\"SELECT key, value FROM settings WHERE key IN ('sms_api_key', 'sms_sender_name')\");\r\n        const settings = settingsStmt.all() as { key: string; value: string }[];\r\n        const settingsMap = settings.reduce((acc, curr) => ({ ...acc, [curr.key]: curr.value }), {} as Record<string, string>);\r\n\r\n        const apiKey = settingsMap['sms_api_key'] || 'Cg4W16D1N9ckkBXhUafP0gS19XB6ZujmMNC5rtkt1e2e6f1c';\r\n        const senderName = settingsMap['sms_sender_name'] || 'School1';\r\n\r\n        const message = `رمز التحقق: ${code}`;\r\n\r\n        // Format number: remove leading 0, prefix with 966\r\n        // 0501234567 -> 966501234567\r\n        let number = mobileNumber.trim();\r\n        if (number.startsWith('0')) {\r\n            number = '966' + number.substring(1);\r\n        } else if (number.startsWith('5')) {\r\n            number = '966' + number;\r\n        }\r\n\r\n        console.log(`[SMS] Sending to ${number}...`);\r\n\r\n        const response = await fetch('https://app.mobile.net.sa/api/v1/send', {\r\n            method: 'POST',\r\n            headers: {\r\n                'Authorization': `Bearer ${apiKey}`,\r\n                'Content-Type': 'application/json',\r\n                'Accept': 'application/json'\r\n            },\r\n            body: JSON.stringify({\r\n                number: number,\r\n                senderName: senderName, // Using default/example sender name to ensure delivery\r\n                sendAtOption: \"Now\",\r\n                messageBody: message,\r\n                allow_duplicate: true\r\n            })\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            console.error('SMS API Error:', errorText);\r\n            // Try to parse JSON error if possible\r\n            try {\r\n                const jsonError = JSON.parse(errorText);\r\n                return { success: false, error: `فشل المزود: ${jsonError.message || JSON.stringify(jsonError)}` };\r\n            } catch {\r\n                return { success: false, error: `فشل المزود: ${errorText.substring(0, 100)}` };\r\n            }\r\n        }\r\n\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Failed to send SMS:', error);\r\n        return { success: false, error: `فشل إرسال الرسالة: ${error.message}` };\r\n    }\r\n}\r\n\r\nexport async function verifyOTP(mobileNumber: string, code: string) {\r\n    const stmt = db.prepare('SELECT code, expires_at FROM otp_codes WHERE mobile_number = ?');\r\n    const result = stmt.get(mobileNumber) as { code: string; expires_at: string };\r\n\r\n    if (!result) return { success: false, error: 'رقم الجوال غير معروف' };\r\n\r\n    if (result.code !== code) return { success: false, error: 'رمز التحقق غير صحيح' };\r\n\r\n    if (new Date(result.expires_at) < new Date()) {\r\n        return { success: false, error: 'انتهت صلاحية الرمز' };\r\n    }\r\n\r\n    // Clear OTP after success\r\n    db.prepare('DELETE FROM otp_codes WHERE mobile_number = ?').run(mobileNumber);\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport interface VisitorData {\r\n    name: string;\r\n    idNumber: string;\r\n    mobileNumber: string;\r\n    purpose: string;\r\n    signature: string; // Base64\r\n}\r\n\r\nexport async function submitVisitor(data: VisitorData) {\r\n    const stmt = db.prepare(`\r\n    INSERT INTO visitors (name, id_number, mobile_number, visit_date, visit_time, purpose, signature)\r\n    VALUES (?, ?, ?, ?, ?, ?, ?)\r\n  `);\r\n\r\n    const now = new Date();\r\n    const date = now.toISOString().split('T')[0]; // YYYY-MM-DD\r\n    const time = now.toLocaleTimeString('en-US', { hour12: false });\r\n\r\n    try {\r\n        const result = stmt.run(\r\n            data.name,\r\n            data.idNumber,\r\n            data.mobileNumber,\r\n            date,\r\n            time,\r\n            data.purpose,\r\n            data.signature\r\n        );\r\n\r\n        revalidatePath('/');\r\n        return { success: true, id: result.lastInsertRowid };\r\n    } catch (error) {\r\n        console.error('Failed to save visitor:', error);\r\n        return { success: false, error: 'Failed to save data' };\r\n    }\r\n}\r\n\r\nexport async function getVisitors(date?: string) {\r\n    // If no date provided, default to today's date\r\n    const targetDate = date || new Date().toISOString().split('T')[0];\r\n\r\n    try {\r\n        const stmt = db.prepare('SELECT * FROM visitors WHERE visit_date = ? ORDER BY id DESC');\r\n        const visitors = stmt.all(targetDate) as any[]; // Type as needed\r\n        return { success: true, data: visitors };\r\n    } catch (error) {\r\n        console.error('Failed to get visitors:', error);\r\n        return { success: false, error: 'Failed to fetch data' };\r\n    }\r\n}\r\n\r\nexport async function getSchoolInfo() {\r\n    try {\r\n        const keys = ['school_country', 'school_ministry', 'school_directorate', 'school_name', 'sms_api_key', 'sms_sender_name', 'enable_otp'];\r\n        const placeholders = keys.map(() => '?').join(',');\r\n        const stmt = db.prepare(`SELECT key, value FROM settings WHERE key IN (${placeholders})`);\r\n        const results = stmt.all(...keys) as { key: string; value: string }[];\r\n\r\n        const info: Record<string, string> = {};\r\n        results.forEach(r => {\r\n            info[r.key] = r.value;\r\n        });\r\n\r\n        return { success: true, data: info };\r\n    } catch (error) {\r\n        console.error('Failed to get school info:', error);\r\n        return { success: false, error: 'Failed to fetch info' };\r\n    }\r\n}\r\n\r\n// Existing import modification\r\nimport * as XLSX from 'xlsx';\r\n\r\n// ... (keep existing functions, I will just append new ones for now, but better to do it cleanly)\r\n\r\nexport async function importStudents(formData: FormData) {\r\n    const file = formData.get('file') as File;\r\n    if (!file) return { success: false, error: 'No file uploaded' };\r\n\r\n    try {\r\n        const bytes = await file.arrayBuffer();\r\n        const buffer = Buffer.from(bytes);\r\n        const workbook = XLSX.read(buffer, { type: 'buffer' });\r\n        const sheetName = workbook.SheetNames[0];\r\n        const sheet = workbook.Sheets[sheetName];\r\n        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });\r\n\r\n        // Expected columns: Name, Grade, Class, ID Number, Mobile\r\n        // Assuming header row exists, start from index 1. If not, check data.\r\n        // Let's assume row 0 is header.\r\n\r\n        const stmt = db.prepare(`\r\n            INSERT INTO students (name, grade, class_name, id_number, mobile_number)\r\n            VALUES (?, ?, ?, ?, ?)\r\n        `);\r\n\r\n        // Use transaction for bulk insert\r\n        const insertMany = db.transaction((rows) => {\r\n            for (const row of rows) {\r\n                // row is array [Name, Grade, Class, ID, Mobile]\r\n                // Be careful with index if header exists\r\n                if (!row[0] || !row[3]) continue; // Skip empty rows or missing mandatory fields\r\n                try {\r\n                    stmt.run(row[0], row[1], row[2], String(row[3]), String(row[4]));\r\n                } catch (e) {\r\n                    console.log('Skipping duplicate or invalid row:', row);\r\n                }\r\n            }\r\n        });\r\n\r\n        // Skip first row (headers)\r\n        const dataRows = jsonData.slice(1);\r\n        insertMany(dataRows);\r\n\r\n        return { success: true, count: dataRows.length };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Failed to process file' };\r\n    }\r\n}\r\n\r\n// ... (existing code)\r\n\r\nexport async function getAllStudents() {\r\n    try {\r\n        const stmt = db.prepare('SELECT * FROM students ORDER BY grade, class_name, name');\r\n        const students = stmt.all();\r\n        return { success: true, data: students };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Failed to fetch students' };\r\n    }\r\n}\r\n\r\nexport async function searchStudents(filters: { name?: string, grade?: string, class_name?: string, id_number?: string, mobile_number?: string }) {\r\n    try {\r\n        let sql = 'SELECT * FROM students WHERE 1=1';\r\n        const params: any[] = [];\r\n\r\n        if (filters.name?.trim()) {\r\n            sql += ' AND name LIKE ?';\r\n            params.push(`%${filters.name.trim()}%`);\r\n        }\r\n        if (filters.grade?.trim()) {\r\n            sql += ' AND grade LIKE ?';\r\n            params.push(`%${filters.grade.trim()}%`);\r\n        }\r\n        if (filters.class_name?.trim()) {\r\n            sql += ' AND class_name LIKE ?';\r\n            params.push(`%${filters.class_name.trim()}%`);\r\n        }\r\n        if (filters.id_number?.trim()) {\r\n            sql += ' AND id_number LIKE ?';\r\n            params.push(`%${filters.id_number.trim()}%`);\r\n        }\r\n        if (filters.mobile_number?.trim()) {\r\n            sql += ' AND mobile_number LIKE ?';\r\n            params.push(`%${filters.mobile_number.trim()}%`);\r\n        }\r\n\r\n        sql += ' LIMIT 20';\r\n\r\n        const stmt = db.prepare(sql);\r\n        const students = stmt.all(...params);\r\n        return { success: true, data: students };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Search failed' };\r\n    }\r\n}\r\n\r\nexport async function createExitPermit(studentId: number, reason: string, authorizer: string) {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            INSERT INTO student_exits (student_id, reason, authorizer)\r\n            VALUES (?, ?, ?)\r\n        `);\r\n        stmt.run(studentId, reason, authorizer);\r\n        revalidatePath('/admin/exit-permit');\r\n        revalidatePath('/guard');\r\n        return { success: true };\r\n    } catch (e) {\r\n        return { success: false, error: 'Failed to create permit' };\r\n    }\r\n}\r\n\r\nexport async function getExitPermits(status = 'PENDING') {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            SELECT e.*, s.name as student_name, s.grade, s.class_name \r\n            FROM student_exits e\r\n            JOIN students s ON e.student_id = s.id\r\n            WHERE e.status = ?\r\n            ORDER BY e.request_time DESC\r\n        `);\r\n        const permits = stmt.all(status);\r\n        return { success: true, data: permits };\r\n    } catch (e) {\r\n        return { success: false, error: 'Fetch failed' };\r\n    }\r\n}\r\n\r\nexport async function confirmExitPermit(id: number) {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            UPDATE student_exits \r\n            SET status = 'EXITED', exit_time = CURRENT_TIMESTAMP\r\n            WHERE id = ?\r\n        `);\r\n        const info = stmt.run(id);\r\n        console.log('Confirm Permit ID:', id, 'Changes:', info.changes);\r\n        if (info.changes === 0) return { success: false, error: 'Permit not found' };\r\n        revalidatePath('/guard');\r\n        revalidatePath('/admin/exit-permit');\r\n        return { success: true };\r\n    } catch (e) {\r\n        return { success: false, error: 'Update failed' };\r\n    }\r\n}\r\n\r\nexport async function getStudentExitReport(date?: string) {\r\n    const targetDate = date || new Date().toISOString().split('T')[0];\r\n    try {\r\n        // Get exits for the day\r\n        const stmt = db.prepare(`\r\n            SELECT e.*, s.name, s.grade, s.class_name, s.id_number\r\n            FROM student_exits e\r\n            JOIN students s ON e.student_id = s.id\r\n            WHERE date(e.exit_time) = ? AND e.status = 'EXITED'\r\n            ORDER BY e.exit_time DESC\r\n        `);\r\n\r\n        const exits = stmt.all(targetDate) as any[];\r\n\r\n        // Calculate cumulative count for each student in the list\r\n        // Could be optimized, but simpler to query individually or group by\r\n\r\n        const exitsWithCount = await Promise.all(exits.map(async (exit) => {\r\n            const countStmt = db.prepare(`\r\n                SELECT COUNT(*) as count FROM student_exits \r\n                WHERE student_id = ? AND status = 'EXITED'\r\n            `);\r\n            const countRes = countStmt.get(exit.student_id) as { count: number };\r\n            return { ...exit, cumulative_count: countRes.count };\r\n        }));\r\n\r\n        return { success: true, data: exitsWithCount };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Report failed' };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MAmJsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,iDAAA"}},
    {"offset": {"line": 38, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MJD8/OneDrive/Desktop/projects/visit/src/app/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { db } from '@/lib/db';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\nexport async function sendOTP(mobileNumber: string) {\r\n    // 1. Generate 4-digit code\r\n    const code = Math.floor(1000 + Math.random() * 9000).toString();\r\n\r\n    // 2. Save to DB with expiration (5 mins)\r\n    const expiresAt = new Date(Date.now() + 5 * 60 * 1000).toISOString();\r\n\r\n    if (process.env.NEXT_PHASE !== 'phase-production-build') {\r\n        const stmt = db.prepare(`\r\n        INSERT OR REPLACE INTO otp_codes (mobile_number, code, expires_at)\r\n        VALUES (?, ?, ?)\r\n      `);\r\n        stmt.run(mobileNumber, code, expiresAt);\r\n    }\r\n\r\n    // 3. Send SMS\r\n    try {\r\n        // Fetch SMS settings from DB\r\n        const settingsStmt = db.prepare(\"SELECT key, value FROM settings WHERE key IN ('sms_api_key', 'sms_sender_name')\");\r\n        const settings = settingsStmt.all() as { key: string; value: string }[];\r\n        const settingsMap = settings.reduce((acc, curr) => ({ ...acc, [curr.key]: curr.value }), {} as Record<string, string>);\r\n\r\n        const apiKey = settingsMap['sms_api_key'] || 'Cg4W16D1N9ckkBXhUafP0gS19XB6ZujmMNC5rtkt1e2e6f1c';\r\n        const senderName = settingsMap['sms_sender_name'] || 'School1';\r\n\r\n        const message = `رمز التحقق: ${code}`;\r\n\r\n        // Format number: remove leading 0, prefix with 966\r\n        // 0501234567 -> 966501234567\r\n        let number = mobileNumber.trim();\r\n        if (number.startsWith('0')) {\r\n            number = '966' + number.substring(1);\r\n        } else if (number.startsWith('5')) {\r\n            number = '966' + number;\r\n        }\r\n\r\n        console.log(`[SMS] Sending to ${number}...`);\r\n\r\n        const response = await fetch('https://app.mobile.net.sa/api/v1/send', {\r\n            method: 'POST',\r\n            headers: {\r\n                'Authorization': `Bearer ${apiKey}`,\r\n                'Content-Type': 'application/json',\r\n                'Accept': 'application/json'\r\n            },\r\n            body: JSON.stringify({\r\n                number: number,\r\n                senderName: senderName, // Using default/example sender name to ensure delivery\r\n                sendAtOption: \"Now\",\r\n                messageBody: message,\r\n                allow_duplicate: true\r\n            })\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            console.error('SMS API Error:', errorText);\r\n            // Try to parse JSON error if possible\r\n            try {\r\n                const jsonError = JSON.parse(errorText);\r\n                return { success: false, error: `فشل المزود: ${jsonError.message || JSON.stringify(jsonError)}` };\r\n            } catch {\r\n                return { success: false, error: `فشل المزود: ${errorText.substring(0, 100)}` };\r\n            }\r\n        }\r\n\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Failed to send SMS:', error);\r\n        return { success: false, error: `فشل إرسال الرسالة: ${error.message}` };\r\n    }\r\n}\r\n\r\nexport async function verifyOTP(mobileNumber: string, code: string) {\r\n    const stmt = db.prepare('SELECT code, expires_at FROM otp_codes WHERE mobile_number = ?');\r\n    const result = stmt.get(mobileNumber) as { code: string; expires_at: string };\r\n\r\n    if (!result) return { success: false, error: 'رقم الجوال غير معروف' };\r\n\r\n    if (result.code !== code) return { success: false, error: 'رمز التحقق غير صحيح' };\r\n\r\n    if (new Date(result.expires_at) < new Date()) {\r\n        return { success: false, error: 'انتهت صلاحية الرمز' };\r\n    }\r\n\r\n    // Clear OTP after success\r\n    db.prepare('DELETE FROM otp_codes WHERE mobile_number = ?').run(mobileNumber);\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport interface VisitorData {\r\n    name: string;\r\n    idNumber: string;\r\n    mobileNumber: string;\r\n    purpose: string;\r\n    signature: string; // Base64\r\n}\r\n\r\nexport async function submitVisitor(data: VisitorData) {\r\n    const stmt = db.prepare(`\r\n    INSERT INTO visitors (name, id_number, mobile_number, visit_date, visit_time, purpose, signature)\r\n    VALUES (?, ?, ?, ?, ?, ?, ?)\r\n  `);\r\n\r\n    const now = new Date();\r\n    const date = now.toISOString().split('T')[0]; // YYYY-MM-DD\r\n    const time = now.toLocaleTimeString('en-US', { hour12: false });\r\n\r\n    try {\r\n        const result = stmt.run(\r\n            data.name,\r\n            data.idNumber,\r\n            data.mobileNumber,\r\n            date,\r\n            time,\r\n            data.purpose,\r\n            data.signature\r\n        );\r\n\r\n        revalidatePath('/');\r\n        return { success: true, id: result.lastInsertRowid };\r\n    } catch (error) {\r\n        console.error('Failed to save visitor:', error);\r\n        return { success: false, error: 'Failed to save data' };\r\n    }\r\n}\r\n\r\nexport async function getVisitors(date?: string) {\r\n    // If no date provided, default to today's date\r\n    const targetDate = date || new Date().toISOString().split('T')[0];\r\n\r\n    try {\r\n        const stmt = db.prepare('SELECT * FROM visitors WHERE visit_date = ? ORDER BY id DESC');\r\n        const visitors = stmt.all(targetDate) as any[]; // Type as needed\r\n        return { success: true, data: visitors };\r\n    } catch (error) {\r\n        console.error('Failed to get visitors:', error);\r\n        return { success: false, error: 'Failed to fetch data' };\r\n    }\r\n}\r\n\r\nexport async function getSchoolInfo() {\r\n    try {\r\n        const keys = ['school_country', 'school_ministry', 'school_directorate', 'school_name', 'sms_api_key', 'sms_sender_name', 'enable_otp'];\r\n        const placeholders = keys.map(() => '?').join(',');\r\n        const stmt = db.prepare(`SELECT key, value FROM settings WHERE key IN (${placeholders})`);\r\n        const results = stmt.all(...keys) as { key: string; value: string }[];\r\n\r\n        const info: Record<string, string> = {};\r\n        results.forEach(r => {\r\n            info[r.key] = r.value;\r\n        });\r\n\r\n        return { success: true, data: info };\r\n    } catch (error) {\r\n        console.error('Failed to get school info:', error);\r\n        return { success: false, error: 'Failed to fetch info' };\r\n    }\r\n}\r\n\r\n// Existing import modification\r\nimport * as XLSX from 'xlsx';\r\n\r\n// ... (keep existing functions, I will just append new ones for now, but better to do it cleanly)\r\n\r\nexport async function importStudents(formData: FormData) {\r\n    const file = formData.get('file') as File;\r\n    if (!file) return { success: false, error: 'No file uploaded' };\r\n\r\n    try {\r\n        const bytes = await file.arrayBuffer();\r\n        const buffer = Buffer.from(bytes);\r\n        const workbook = XLSX.read(buffer, { type: 'buffer' });\r\n        const sheetName = workbook.SheetNames[0];\r\n        const sheet = workbook.Sheets[sheetName];\r\n        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });\r\n\r\n        // Expected columns: Name, Grade, Class, ID Number, Mobile\r\n        // Assuming header row exists, start from index 1. If not, check data.\r\n        // Let's assume row 0 is header.\r\n\r\n        const stmt = db.prepare(`\r\n            INSERT INTO students (name, grade, class_name, id_number, mobile_number)\r\n            VALUES (?, ?, ?, ?, ?)\r\n        `);\r\n\r\n        // Use transaction for bulk insert\r\n        const insertMany = db.transaction((rows) => {\r\n            for (const row of rows) {\r\n                // row is array [Name, Grade, Class, ID, Mobile]\r\n                // Be careful with index if header exists\r\n                if (!row[0] || !row[3]) continue; // Skip empty rows or missing mandatory fields\r\n                try {\r\n                    stmt.run(row[0], row[1], row[2], String(row[3]), String(row[4]));\r\n                } catch (e) {\r\n                    console.log('Skipping duplicate or invalid row:', row);\r\n                }\r\n            }\r\n        });\r\n\r\n        // Skip first row (headers)\r\n        const dataRows = jsonData.slice(1);\r\n        insertMany(dataRows);\r\n\r\n        return { success: true, count: dataRows.length };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Failed to process file' };\r\n    }\r\n}\r\n\r\n// ... (existing code)\r\n\r\nexport async function getAllStudents() {\r\n    try {\r\n        const stmt = db.prepare('SELECT * FROM students ORDER BY grade, class_name, name');\r\n        const students = stmt.all();\r\n        return { success: true, data: students };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Failed to fetch students' };\r\n    }\r\n}\r\n\r\nexport async function searchStudents(filters: { name?: string, grade?: string, class_name?: string, id_number?: string, mobile_number?: string }) {\r\n    try {\r\n        let sql = 'SELECT * FROM students WHERE 1=1';\r\n        const params: any[] = [];\r\n\r\n        if (filters.name?.trim()) {\r\n            sql += ' AND name LIKE ?';\r\n            params.push(`%${filters.name.trim()}%`);\r\n        }\r\n        if (filters.grade?.trim()) {\r\n            sql += ' AND grade LIKE ?';\r\n            params.push(`%${filters.grade.trim()}%`);\r\n        }\r\n        if (filters.class_name?.trim()) {\r\n            sql += ' AND class_name LIKE ?';\r\n            params.push(`%${filters.class_name.trim()}%`);\r\n        }\r\n        if (filters.id_number?.trim()) {\r\n            sql += ' AND id_number LIKE ?';\r\n            params.push(`%${filters.id_number.trim()}%`);\r\n        }\r\n        if (filters.mobile_number?.trim()) {\r\n            sql += ' AND mobile_number LIKE ?';\r\n            params.push(`%${filters.mobile_number.trim()}%`);\r\n        }\r\n\r\n        sql += ' LIMIT 20';\r\n\r\n        const stmt = db.prepare(sql);\r\n        const students = stmt.all(...params);\r\n        return { success: true, data: students };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Search failed' };\r\n    }\r\n}\r\n\r\nexport async function createExitPermit(studentId: number, reason: string, authorizer: string) {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            INSERT INTO student_exits (student_id, reason, authorizer)\r\n            VALUES (?, ?, ?)\r\n        `);\r\n        stmt.run(studentId, reason, authorizer);\r\n        revalidatePath('/admin/exit-permit');\r\n        revalidatePath('/guard');\r\n        return { success: true };\r\n    } catch (e) {\r\n        return { success: false, error: 'Failed to create permit' };\r\n    }\r\n}\r\n\r\nexport async function getExitPermits(status = 'PENDING') {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            SELECT e.*, s.name as student_name, s.grade, s.class_name \r\n            FROM student_exits e\r\n            JOIN students s ON e.student_id = s.id\r\n            WHERE e.status = ?\r\n            ORDER BY e.request_time DESC\r\n        `);\r\n        const permits = stmt.all(status);\r\n        return { success: true, data: permits };\r\n    } catch (e) {\r\n        return { success: false, error: 'Fetch failed' };\r\n    }\r\n}\r\n\r\nexport async function confirmExitPermit(id: number) {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            UPDATE student_exits \r\n            SET status = 'EXITED', exit_time = CURRENT_TIMESTAMP\r\n            WHERE id = ?\r\n        `);\r\n        const info = stmt.run(id);\r\n        console.log('Confirm Permit ID:', id, 'Changes:', info.changes);\r\n        if (info.changes === 0) return { success: false, error: 'Permit not found' };\r\n        revalidatePath('/guard');\r\n        revalidatePath('/admin/exit-permit');\r\n        return { success: true };\r\n    } catch (e) {\r\n        return { success: false, error: 'Update failed' };\r\n    }\r\n}\r\n\r\nexport async function getStudentExitReport(date?: string) {\r\n    const targetDate = date || new Date().toISOString().split('T')[0];\r\n    try {\r\n        // Get exits for the day\r\n        const stmt = db.prepare(`\r\n            SELECT e.*, s.name, s.grade, s.class_name, s.id_number\r\n            FROM student_exits e\r\n            JOIN students s ON e.student_id = s.id\r\n            WHERE date(e.exit_time) = ? AND e.status = 'EXITED'\r\n            ORDER BY e.exit_time DESC\r\n        `);\r\n\r\n        const exits = stmt.all(targetDate) as any[];\r\n\r\n        // Calculate cumulative count for each student in the list\r\n        // Could be optimized, but simpler to query individually or group by\r\n\r\n        const exitsWithCount = await Promise.all(exits.map(async (exit) => {\r\n            const countStmt = db.prepare(`\r\n                SELECT COUNT(*) as count FROM student_exits \r\n                WHERE student_id = ? AND status = 'EXITED'\r\n            `);\r\n            const countRes = countStmt.get(exit.student_id) as { count: number };\r\n            return { ...exit, cumulative_count: countRes.count };\r\n        }));\r\n\r\n        return { success: true, data: exitsWithCount };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Report failed' };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MA2QsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,oDAAA"}},
    {"offset": {"line": 55, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MJD8/OneDrive/Desktop/projects/visit/src/app/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { db } from '@/lib/db';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\nexport async function sendOTP(mobileNumber: string) {\r\n    // 1. Generate 4-digit code\r\n    const code = Math.floor(1000 + Math.random() * 9000).toString();\r\n\r\n    // 2. Save to DB with expiration (5 mins)\r\n    const expiresAt = new Date(Date.now() + 5 * 60 * 1000).toISOString();\r\n\r\n    if (process.env.NEXT_PHASE !== 'phase-production-build') {\r\n        const stmt = db.prepare(`\r\n        INSERT OR REPLACE INTO otp_codes (mobile_number, code, expires_at)\r\n        VALUES (?, ?, ?)\r\n      `);\r\n        stmt.run(mobileNumber, code, expiresAt);\r\n    }\r\n\r\n    // 3. Send SMS\r\n    try {\r\n        // Fetch SMS settings from DB\r\n        const settingsStmt = db.prepare(\"SELECT key, value FROM settings WHERE key IN ('sms_api_key', 'sms_sender_name')\");\r\n        const settings = settingsStmt.all() as { key: string; value: string }[];\r\n        const settingsMap = settings.reduce((acc, curr) => ({ ...acc, [curr.key]: curr.value }), {} as Record<string, string>);\r\n\r\n        const apiKey = settingsMap['sms_api_key'] || 'Cg4W16D1N9ckkBXhUafP0gS19XB6ZujmMNC5rtkt1e2e6f1c';\r\n        const senderName = settingsMap['sms_sender_name'] || 'School1';\r\n\r\n        const message = `رمز التحقق: ${code}`;\r\n\r\n        // Format number: remove leading 0, prefix with 966\r\n        // 0501234567 -> 966501234567\r\n        let number = mobileNumber.trim();\r\n        if (number.startsWith('0')) {\r\n            number = '966' + number.substring(1);\r\n        } else if (number.startsWith('5')) {\r\n            number = '966' + number;\r\n        }\r\n\r\n        console.log(`[SMS] Sending to ${number}...`);\r\n\r\n        const response = await fetch('https://app.mobile.net.sa/api/v1/send', {\r\n            method: 'POST',\r\n            headers: {\r\n                'Authorization': `Bearer ${apiKey}`,\r\n                'Content-Type': 'application/json',\r\n                'Accept': 'application/json'\r\n            },\r\n            body: JSON.stringify({\r\n                number: number,\r\n                senderName: senderName, // Using default/example sender name to ensure delivery\r\n                sendAtOption: \"Now\",\r\n                messageBody: message,\r\n                allow_duplicate: true\r\n            })\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            console.error('SMS API Error:', errorText);\r\n            // Try to parse JSON error if possible\r\n            try {\r\n                const jsonError = JSON.parse(errorText);\r\n                return { success: false, error: `فشل المزود: ${jsonError.message || JSON.stringify(jsonError)}` };\r\n            } catch {\r\n                return { success: false, error: `فشل المزود: ${errorText.substring(0, 100)}` };\r\n            }\r\n        }\r\n\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Failed to send SMS:', error);\r\n        return { success: false, error: `فشل إرسال الرسالة: ${error.message}` };\r\n    }\r\n}\r\n\r\nexport async function verifyOTP(mobileNumber: string, code: string) {\r\n    const stmt = db.prepare('SELECT code, expires_at FROM otp_codes WHERE mobile_number = ?');\r\n    const result = stmt.get(mobileNumber) as { code: string; expires_at: string };\r\n\r\n    if (!result) return { success: false, error: 'رقم الجوال غير معروف' };\r\n\r\n    if (result.code !== code) return { success: false, error: 'رمز التحقق غير صحيح' };\r\n\r\n    if (new Date(result.expires_at) < new Date()) {\r\n        return { success: false, error: 'انتهت صلاحية الرمز' };\r\n    }\r\n\r\n    // Clear OTP after success\r\n    db.prepare('DELETE FROM otp_codes WHERE mobile_number = ?').run(mobileNumber);\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport interface VisitorData {\r\n    name: string;\r\n    idNumber: string;\r\n    mobileNumber: string;\r\n    purpose: string;\r\n    signature: string; // Base64\r\n}\r\n\r\nexport async function submitVisitor(data: VisitorData) {\r\n    const stmt = db.prepare(`\r\n    INSERT INTO visitors (name, id_number, mobile_number, visit_date, visit_time, purpose, signature)\r\n    VALUES (?, ?, ?, ?, ?, ?, ?)\r\n  `);\r\n\r\n    const now = new Date();\r\n    const date = now.toISOString().split('T')[0]; // YYYY-MM-DD\r\n    const time = now.toLocaleTimeString('en-US', { hour12: false });\r\n\r\n    try {\r\n        const result = stmt.run(\r\n            data.name,\r\n            data.idNumber,\r\n            data.mobileNumber,\r\n            date,\r\n            time,\r\n            data.purpose,\r\n            data.signature\r\n        );\r\n\r\n        revalidatePath('/');\r\n        return { success: true, id: result.lastInsertRowid };\r\n    } catch (error) {\r\n        console.error('Failed to save visitor:', error);\r\n        return { success: false, error: 'Failed to save data' };\r\n    }\r\n}\r\n\r\nexport async function getVisitors(date?: string) {\r\n    // If no date provided, default to today's date\r\n    const targetDate = date || new Date().toISOString().split('T')[0];\r\n\r\n    try {\r\n        const stmt = db.prepare('SELECT * FROM visitors WHERE visit_date = ? ORDER BY id DESC');\r\n        const visitors = stmt.all(targetDate) as any[]; // Type as needed\r\n        return { success: true, data: visitors };\r\n    } catch (error) {\r\n        console.error('Failed to get visitors:', error);\r\n        return { success: false, error: 'Failed to fetch data' };\r\n    }\r\n}\r\n\r\nexport async function getSchoolInfo() {\r\n    try {\r\n        const keys = ['school_country', 'school_ministry', 'school_directorate', 'school_name', 'sms_api_key', 'sms_sender_name', 'enable_otp'];\r\n        const placeholders = keys.map(() => '?').join(',');\r\n        const stmt = db.prepare(`SELECT key, value FROM settings WHERE key IN (${placeholders})`);\r\n        const results = stmt.all(...keys) as { key: string; value: string }[];\r\n\r\n        const info: Record<string, string> = {};\r\n        results.forEach(r => {\r\n            info[r.key] = r.value;\r\n        });\r\n\r\n        return { success: true, data: info };\r\n    } catch (error) {\r\n        console.error('Failed to get school info:', error);\r\n        return { success: false, error: 'Failed to fetch info' };\r\n    }\r\n}\r\n\r\n// Existing import modification\r\nimport * as XLSX from 'xlsx';\r\n\r\n// ... (keep existing functions, I will just append new ones for now, but better to do it cleanly)\r\n\r\nexport async function importStudents(formData: FormData) {\r\n    const file = formData.get('file') as File;\r\n    if (!file) return { success: false, error: 'No file uploaded' };\r\n\r\n    try {\r\n        const bytes = await file.arrayBuffer();\r\n        const buffer = Buffer.from(bytes);\r\n        const workbook = XLSX.read(buffer, { type: 'buffer' });\r\n        const sheetName = workbook.SheetNames[0];\r\n        const sheet = workbook.Sheets[sheetName];\r\n        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });\r\n\r\n        // Expected columns: Name, Grade, Class, ID Number, Mobile\r\n        // Assuming header row exists, start from index 1. If not, check data.\r\n        // Let's assume row 0 is header.\r\n\r\n        const stmt = db.prepare(`\r\n            INSERT INTO students (name, grade, class_name, id_number, mobile_number)\r\n            VALUES (?, ?, ?, ?, ?)\r\n        `);\r\n\r\n        // Use transaction for bulk insert\r\n        const insertMany = db.transaction((rows) => {\r\n            for (const row of rows) {\r\n                // row is array [Name, Grade, Class, ID, Mobile]\r\n                // Be careful with index if header exists\r\n                if (!row[0] || !row[3]) continue; // Skip empty rows or missing mandatory fields\r\n                try {\r\n                    stmt.run(row[0], row[1], row[2], String(row[3]), String(row[4]));\r\n                } catch (e) {\r\n                    console.log('Skipping duplicate or invalid row:', row);\r\n                }\r\n            }\r\n        });\r\n\r\n        // Skip first row (headers)\r\n        const dataRows = jsonData.slice(1);\r\n        insertMany(dataRows);\r\n\r\n        return { success: true, count: dataRows.length };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Failed to process file' };\r\n    }\r\n}\r\n\r\n// ... (existing code)\r\n\r\nexport async function getAllStudents() {\r\n    try {\r\n        const stmt = db.prepare('SELECT * FROM students ORDER BY grade, class_name, name');\r\n        const students = stmt.all();\r\n        return { success: true, data: students };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Failed to fetch students' };\r\n    }\r\n}\r\n\r\nexport async function searchStudents(filters: { name?: string, grade?: string, class_name?: string, id_number?: string, mobile_number?: string }) {\r\n    try {\r\n        let sql = 'SELECT * FROM students WHERE 1=1';\r\n        const params: any[] = [];\r\n\r\n        if (filters.name?.trim()) {\r\n            sql += ' AND name LIKE ?';\r\n            params.push(`%${filters.name.trim()}%`);\r\n        }\r\n        if (filters.grade?.trim()) {\r\n            sql += ' AND grade LIKE ?';\r\n            params.push(`%${filters.grade.trim()}%`);\r\n        }\r\n        if (filters.class_name?.trim()) {\r\n            sql += ' AND class_name LIKE ?';\r\n            params.push(`%${filters.class_name.trim()}%`);\r\n        }\r\n        if (filters.id_number?.trim()) {\r\n            sql += ' AND id_number LIKE ?';\r\n            params.push(`%${filters.id_number.trim()}%`);\r\n        }\r\n        if (filters.mobile_number?.trim()) {\r\n            sql += ' AND mobile_number LIKE ?';\r\n            params.push(`%${filters.mobile_number.trim()}%`);\r\n        }\r\n\r\n        sql += ' LIMIT 20';\r\n\r\n        const stmt = db.prepare(sql);\r\n        const students = stmt.all(...params);\r\n        return { success: true, data: students };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Search failed' };\r\n    }\r\n}\r\n\r\nexport async function createExitPermit(studentId: number, reason: string, authorizer: string) {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            INSERT INTO student_exits (student_id, reason, authorizer)\r\n            VALUES (?, ?, ?)\r\n        `);\r\n        stmt.run(studentId, reason, authorizer);\r\n        revalidatePath('/admin/exit-permit');\r\n        revalidatePath('/guard');\r\n        return { success: true };\r\n    } catch (e) {\r\n        return { success: false, error: 'Failed to create permit' };\r\n    }\r\n}\r\n\r\nexport async function getExitPermits(status = 'PENDING') {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            SELECT e.*, s.name as student_name, s.grade, s.class_name \r\n            FROM student_exits e\r\n            JOIN students s ON e.student_id = s.id\r\n            WHERE e.status = ?\r\n            ORDER BY e.request_time DESC\r\n        `);\r\n        const permits = stmt.all(status);\r\n        return { success: true, data: permits };\r\n    } catch (e) {\r\n        return { success: false, error: 'Fetch failed' };\r\n    }\r\n}\r\n\r\nexport async function confirmExitPermit(id: number) {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            UPDATE student_exits \r\n            SET status = 'EXITED', exit_time = CURRENT_TIMESTAMP\r\n            WHERE id = ?\r\n        `);\r\n        const info = stmt.run(id);\r\n        console.log('Confirm Permit ID:', id, 'Changes:', info.changes);\r\n        if (info.changes === 0) return { success: false, error: 'Permit not found' };\r\n        revalidatePath('/guard');\r\n        revalidatePath('/admin/exit-permit');\r\n        return { success: true };\r\n    } catch (e) {\r\n        return { success: false, error: 'Update failed' };\r\n    }\r\n}\r\n\r\nexport async function getStudentExitReport(date?: string) {\r\n    const targetDate = date || new Date().toISOString().split('T')[0];\r\n    try {\r\n        // Get exits for the day\r\n        const stmt = db.prepare(`\r\n            SELECT e.*, s.name, s.grade, s.class_name, s.id_number\r\n            FROM student_exits e\r\n            JOIN students s ON e.student_id = s.id\r\n            WHERE date(e.exit_time) = ? AND e.status = 'EXITED'\r\n            ORDER BY e.exit_time DESC\r\n        `);\r\n\r\n        const exits = stmt.all(targetDate) as any[];\r\n\r\n        // Calculate cumulative count for each student in the list\r\n        // Could be optimized, but simpler to query individually or group by\r\n\r\n        const exitsWithCount = await Promise.all(exits.map(async (exit) => {\r\n            const countStmt = db.prepare(`\r\n                SELECT COUNT(*) as count FROM student_exits \r\n                WHERE student_id = ? AND status = 'EXITED'\r\n            `);\r\n            const countRes = countStmt.get(exit.student_id) as { count: number };\r\n            return { ...exit, cumulative_count: countRes.count };\r\n        }));\r\n\r\n        return { success: true, data: exitsWithCount };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Report failed' };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MA2KsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,kDAAA"}},
    {"offset": {"line": 72, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MJD8/OneDrive/Desktop/projects/visit/src/app/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { db } from '@/lib/db';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\nexport async function sendOTP(mobileNumber: string) {\r\n    // 1. Generate 4-digit code\r\n    const code = Math.floor(1000 + Math.random() * 9000).toString();\r\n\r\n    // 2. Save to DB with expiration (5 mins)\r\n    const expiresAt = new Date(Date.now() + 5 * 60 * 1000).toISOString();\r\n\r\n    if (process.env.NEXT_PHASE !== 'phase-production-build') {\r\n        const stmt = db.prepare(`\r\n        INSERT OR REPLACE INTO otp_codes (mobile_number, code, expires_at)\r\n        VALUES (?, ?, ?)\r\n      `);\r\n        stmt.run(mobileNumber, code, expiresAt);\r\n    }\r\n\r\n    // 3. Send SMS\r\n    try {\r\n        // Fetch SMS settings from DB\r\n        const settingsStmt = db.prepare(\"SELECT key, value FROM settings WHERE key IN ('sms_api_key', 'sms_sender_name')\");\r\n        const settings = settingsStmt.all() as { key: string; value: string }[];\r\n        const settingsMap = settings.reduce((acc, curr) => ({ ...acc, [curr.key]: curr.value }), {} as Record<string, string>);\r\n\r\n        const apiKey = settingsMap['sms_api_key'] || 'Cg4W16D1N9ckkBXhUafP0gS19XB6ZujmMNC5rtkt1e2e6f1c';\r\n        const senderName = settingsMap['sms_sender_name'] || 'School1';\r\n\r\n        const message = `رمز التحقق: ${code}`;\r\n\r\n        // Format number: remove leading 0, prefix with 966\r\n        // 0501234567 -> 966501234567\r\n        let number = mobileNumber.trim();\r\n        if (number.startsWith('0')) {\r\n            number = '966' + number.substring(1);\r\n        } else if (number.startsWith('5')) {\r\n            number = '966' + number;\r\n        }\r\n\r\n        console.log(`[SMS] Sending to ${number}...`);\r\n\r\n        const response = await fetch('https://app.mobile.net.sa/api/v1/send', {\r\n            method: 'POST',\r\n            headers: {\r\n                'Authorization': `Bearer ${apiKey}`,\r\n                'Content-Type': 'application/json',\r\n                'Accept': 'application/json'\r\n            },\r\n            body: JSON.stringify({\r\n                number: number,\r\n                senderName: senderName, // Using default/example sender name to ensure delivery\r\n                sendAtOption: \"Now\",\r\n                messageBody: message,\r\n                allow_duplicate: true\r\n            })\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            console.error('SMS API Error:', errorText);\r\n            // Try to parse JSON error if possible\r\n            try {\r\n                const jsonError = JSON.parse(errorText);\r\n                return { success: false, error: `فشل المزود: ${jsonError.message || JSON.stringify(jsonError)}` };\r\n            } catch {\r\n                return { success: false, error: `فشل المزود: ${errorText.substring(0, 100)}` };\r\n            }\r\n        }\r\n\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Failed to send SMS:', error);\r\n        return { success: false, error: `فشل إرسال الرسالة: ${error.message}` };\r\n    }\r\n}\r\n\r\nexport async function verifyOTP(mobileNumber: string, code: string) {\r\n    const stmt = db.prepare('SELECT code, expires_at FROM otp_codes WHERE mobile_number = ?');\r\n    const result = stmt.get(mobileNumber) as { code: string; expires_at: string };\r\n\r\n    if (!result) return { success: false, error: 'رقم الجوال غير معروف' };\r\n\r\n    if (result.code !== code) return { success: false, error: 'رمز التحقق غير صحيح' };\r\n\r\n    if (new Date(result.expires_at) < new Date()) {\r\n        return { success: false, error: 'انتهت صلاحية الرمز' };\r\n    }\r\n\r\n    // Clear OTP after success\r\n    db.prepare('DELETE FROM otp_codes WHERE mobile_number = ?').run(mobileNumber);\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport interface VisitorData {\r\n    name: string;\r\n    idNumber: string;\r\n    mobileNumber: string;\r\n    purpose: string;\r\n    signature: string; // Base64\r\n}\r\n\r\nexport async function submitVisitor(data: VisitorData) {\r\n    const stmt = db.prepare(`\r\n    INSERT INTO visitors (name, id_number, mobile_number, visit_date, visit_time, purpose, signature)\r\n    VALUES (?, ?, ?, ?, ?, ?, ?)\r\n  `);\r\n\r\n    const now = new Date();\r\n    const date = now.toISOString().split('T')[0]; // YYYY-MM-DD\r\n    const time = now.toLocaleTimeString('en-US', { hour12: false });\r\n\r\n    try {\r\n        const result = stmt.run(\r\n            data.name,\r\n            data.idNumber,\r\n            data.mobileNumber,\r\n            date,\r\n            time,\r\n            data.purpose,\r\n            data.signature\r\n        );\r\n\r\n        revalidatePath('/');\r\n        return { success: true, id: result.lastInsertRowid };\r\n    } catch (error) {\r\n        console.error('Failed to save visitor:', error);\r\n        return { success: false, error: 'Failed to save data' };\r\n    }\r\n}\r\n\r\nexport async function getVisitors(date?: string) {\r\n    // If no date provided, default to today's date\r\n    const targetDate = date || new Date().toISOString().split('T')[0];\r\n\r\n    try {\r\n        const stmt = db.prepare('SELECT * FROM visitors WHERE visit_date = ? ORDER BY id DESC');\r\n        const visitors = stmt.all(targetDate) as any[]; // Type as needed\r\n        return { success: true, data: visitors };\r\n    } catch (error) {\r\n        console.error('Failed to get visitors:', error);\r\n        return { success: false, error: 'Failed to fetch data' };\r\n    }\r\n}\r\n\r\nexport async function getSchoolInfo() {\r\n    try {\r\n        const keys = ['school_country', 'school_ministry', 'school_directorate', 'school_name', 'sms_api_key', 'sms_sender_name', 'enable_otp'];\r\n        const placeholders = keys.map(() => '?').join(',');\r\n        const stmt = db.prepare(`SELECT key, value FROM settings WHERE key IN (${placeholders})`);\r\n        const results = stmt.all(...keys) as { key: string; value: string }[];\r\n\r\n        const info: Record<string, string> = {};\r\n        results.forEach(r => {\r\n            info[r.key] = r.value;\r\n        });\r\n\r\n        return { success: true, data: info };\r\n    } catch (error) {\r\n        console.error('Failed to get school info:', error);\r\n        return { success: false, error: 'Failed to fetch info' };\r\n    }\r\n}\r\n\r\n// Existing import modification\r\nimport * as XLSX from 'xlsx';\r\n\r\n// ... (keep existing functions, I will just append new ones for now, but better to do it cleanly)\r\n\r\nexport async function importStudents(formData: FormData) {\r\n    const file = formData.get('file') as File;\r\n    if (!file) return { success: false, error: 'No file uploaded' };\r\n\r\n    try {\r\n        const bytes = await file.arrayBuffer();\r\n        const buffer = Buffer.from(bytes);\r\n        const workbook = XLSX.read(buffer, { type: 'buffer' });\r\n        const sheetName = workbook.SheetNames[0];\r\n        const sheet = workbook.Sheets[sheetName];\r\n        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });\r\n\r\n        // Expected columns: Name, Grade, Class, ID Number, Mobile\r\n        // Assuming header row exists, start from index 1. If not, check data.\r\n        // Let's assume row 0 is header.\r\n\r\n        const stmt = db.prepare(`\r\n            INSERT INTO students (name, grade, class_name, id_number, mobile_number)\r\n            VALUES (?, ?, ?, ?, ?)\r\n        `);\r\n\r\n        // Use transaction for bulk insert\r\n        const insertMany = db.transaction((rows) => {\r\n            for (const row of rows) {\r\n                // row is array [Name, Grade, Class, ID, Mobile]\r\n                // Be careful with index if header exists\r\n                if (!row[0] || !row[3]) continue; // Skip empty rows or missing mandatory fields\r\n                try {\r\n                    stmt.run(row[0], row[1], row[2], String(row[3]), String(row[4]));\r\n                } catch (e) {\r\n                    console.log('Skipping duplicate or invalid row:', row);\r\n                }\r\n            }\r\n        });\r\n\r\n        // Skip first row (headers)\r\n        const dataRows = jsonData.slice(1);\r\n        insertMany(dataRows);\r\n\r\n        return { success: true, count: dataRows.length };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Failed to process file' };\r\n    }\r\n}\r\n\r\n// ... (existing code)\r\n\r\nexport async function getAllStudents() {\r\n    try {\r\n        const stmt = db.prepare('SELECT * FROM students ORDER BY grade, class_name, name');\r\n        const students = stmt.all();\r\n        return { success: true, data: students };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Failed to fetch students' };\r\n    }\r\n}\r\n\r\nexport async function searchStudents(filters: { name?: string, grade?: string, class_name?: string, id_number?: string, mobile_number?: string }) {\r\n    try {\r\n        let sql = 'SELECT * FROM students WHERE 1=1';\r\n        const params: any[] = [];\r\n\r\n        if (filters.name?.trim()) {\r\n            sql += ' AND name LIKE ?';\r\n            params.push(`%${filters.name.trim()}%`);\r\n        }\r\n        if (filters.grade?.trim()) {\r\n            sql += ' AND grade LIKE ?';\r\n            params.push(`%${filters.grade.trim()}%`);\r\n        }\r\n        if (filters.class_name?.trim()) {\r\n            sql += ' AND class_name LIKE ?';\r\n            params.push(`%${filters.class_name.trim()}%`);\r\n        }\r\n        if (filters.id_number?.trim()) {\r\n            sql += ' AND id_number LIKE ?';\r\n            params.push(`%${filters.id_number.trim()}%`);\r\n        }\r\n        if (filters.mobile_number?.trim()) {\r\n            sql += ' AND mobile_number LIKE ?';\r\n            params.push(`%${filters.mobile_number.trim()}%`);\r\n        }\r\n\r\n        sql += ' LIMIT 20';\r\n\r\n        const stmt = db.prepare(sql);\r\n        const students = stmt.all(...params);\r\n        return { success: true, data: students };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Search failed' };\r\n    }\r\n}\r\n\r\nexport async function createExitPermit(studentId: number, reason: string, authorizer: string) {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            INSERT INTO student_exits (student_id, reason, authorizer)\r\n            VALUES (?, ?, ?)\r\n        `);\r\n        stmt.run(studentId, reason, authorizer);\r\n        revalidatePath('/admin/exit-permit');\r\n        revalidatePath('/guard');\r\n        return { success: true };\r\n    } catch (e) {\r\n        return { success: false, error: 'Failed to create permit' };\r\n    }\r\n}\r\n\r\nexport async function getExitPermits(status = 'PENDING') {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            SELECT e.*, s.name as student_name, s.grade, s.class_name \r\n            FROM student_exits e\r\n            JOIN students s ON e.student_id = s.id\r\n            WHERE e.status = ?\r\n            ORDER BY e.request_time DESC\r\n        `);\r\n        const permits = stmt.all(status);\r\n        return { success: true, data: permits };\r\n    } catch (e) {\r\n        return { success: false, error: 'Fetch failed' };\r\n    }\r\n}\r\n\r\nexport async function confirmExitPermit(id: number) {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            UPDATE student_exits \r\n            SET status = 'EXITED', exit_time = CURRENT_TIMESTAMP\r\n            WHERE id = ?\r\n        `);\r\n        const info = stmt.run(id);\r\n        console.log('Confirm Permit ID:', id, 'Changes:', info.changes);\r\n        if (info.changes === 0) return { success: false, error: 'Permit not found' };\r\n        revalidatePath('/guard');\r\n        revalidatePath('/admin/exit-permit');\r\n        return { success: true };\r\n    } catch (e) {\r\n        return { success: false, error: 'Update failed' };\r\n    }\r\n}\r\n\r\nexport async function getStudentExitReport(date?: string) {\r\n    const targetDate = date || new Date().toISOString().split('T')[0];\r\n    try {\r\n        // Get exits for the day\r\n        const stmt = db.prepare(`\r\n            SELECT e.*, s.name, s.grade, s.class_name, s.id_number\r\n            FROM student_exits e\r\n            JOIN students s ON e.student_id = s.id\r\n            WHERE date(e.exit_time) = ? AND e.status = 'EXITED'\r\n            ORDER BY e.exit_time DESC\r\n        `);\r\n\r\n        const exits = stmt.all(targetDate) as any[];\r\n\r\n        // Calculate cumulative count for each student in the list\r\n        // Could be optimized, but simpler to query individually or group by\r\n\r\n        const exitsWithCount = await Promise.all(exits.map(async (exit) => {\r\n            const countStmt = db.prepare(`\r\n                SELECT COUNT(*) as count FROM student_exits \r\n                WHERE student_id = ? AND status = 'EXITED'\r\n            `);\r\n            const countRes = countStmt.get(exit.student_id) as { count: number };\r\n            return { ...exit, cumulative_count: countRes.count };\r\n        }));\r\n\r\n        return { success: true, data: exitsWithCount };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Report failed' };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MA2NsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,kDAAA"}},
    {"offset": {"line": 89, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MJD8/OneDrive/Desktop/projects/visit/src/app/actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { db } from '@/lib/db';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\nexport async function sendOTP(mobileNumber: string) {\r\n    // 1. Generate 4-digit code\r\n    const code = Math.floor(1000 + Math.random() * 9000).toString();\r\n\r\n    // 2. Save to DB with expiration (5 mins)\r\n    const expiresAt = new Date(Date.now() + 5 * 60 * 1000).toISOString();\r\n\r\n    if (process.env.NEXT_PHASE !== 'phase-production-build') {\r\n        const stmt = db.prepare(`\r\n        INSERT OR REPLACE INTO otp_codes (mobile_number, code, expires_at)\r\n        VALUES (?, ?, ?)\r\n      `);\r\n        stmt.run(mobileNumber, code, expiresAt);\r\n    }\r\n\r\n    // 3. Send SMS\r\n    try {\r\n        // Fetch SMS settings from DB\r\n        const settingsStmt = db.prepare(\"SELECT key, value FROM settings WHERE key IN ('sms_api_key', 'sms_sender_name')\");\r\n        const settings = settingsStmt.all() as { key: string; value: string }[];\r\n        const settingsMap = settings.reduce((acc, curr) => ({ ...acc, [curr.key]: curr.value }), {} as Record<string, string>);\r\n\r\n        const apiKey = settingsMap['sms_api_key'] || 'Cg4W16D1N9ckkBXhUafP0gS19XB6ZujmMNC5rtkt1e2e6f1c';\r\n        const senderName = settingsMap['sms_sender_name'] || 'School1';\r\n\r\n        const message = `رمز التحقق: ${code}`;\r\n\r\n        // Format number: remove leading 0, prefix with 966\r\n        // 0501234567 -> 966501234567\r\n        let number = mobileNumber.trim();\r\n        if (number.startsWith('0')) {\r\n            number = '966' + number.substring(1);\r\n        } else if (number.startsWith('5')) {\r\n            number = '966' + number;\r\n        }\r\n\r\n        console.log(`[SMS] Sending to ${number}...`);\r\n\r\n        const response = await fetch('https://app.mobile.net.sa/api/v1/send', {\r\n            method: 'POST',\r\n            headers: {\r\n                'Authorization': `Bearer ${apiKey}`,\r\n                'Content-Type': 'application/json',\r\n                'Accept': 'application/json'\r\n            },\r\n            body: JSON.stringify({\r\n                number: number,\r\n                senderName: senderName, // Using default/example sender name to ensure delivery\r\n                sendAtOption: \"Now\",\r\n                messageBody: message,\r\n                allow_duplicate: true\r\n            })\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            console.error('SMS API Error:', errorText);\r\n            // Try to parse JSON error if possible\r\n            try {\r\n                const jsonError = JSON.parse(errorText);\r\n                return { success: false, error: `فشل المزود: ${jsonError.message || JSON.stringify(jsonError)}` };\r\n            } catch {\r\n                return { success: false, error: `فشل المزود: ${errorText.substring(0, 100)}` };\r\n            }\r\n        }\r\n\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('Failed to send SMS:', error);\r\n        return { success: false, error: `فشل إرسال الرسالة: ${error.message}` };\r\n    }\r\n}\r\n\r\nexport async function verifyOTP(mobileNumber: string, code: string) {\r\n    const stmt = db.prepare('SELECT code, expires_at FROM otp_codes WHERE mobile_number = ?');\r\n    const result = stmt.get(mobileNumber) as { code: string; expires_at: string };\r\n\r\n    if (!result) return { success: false, error: 'رقم الجوال غير معروف' };\r\n\r\n    if (result.code !== code) return { success: false, error: 'رمز التحقق غير صحيح' };\r\n\r\n    if (new Date(result.expires_at) < new Date()) {\r\n        return { success: false, error: 'انتهت صلاحية الرمز' };\r\n    }\r\n\r\n    // Clear OTP after success\r\n    db.prepare('DELETE FROM otp_codes WHERE mobile_number = ?').run(mobileNumber);\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport interface VisitorData {\r\n    name: string;\r\n    idNumber: string;\r\n    mobileNumber: string;\r\n    purpose: string;\r\n    signature: string; // Base64\r\n}\r\n\r\nexport async function submitVisitor(data: VisitorData) {\r\n    const stmt = db.prepare(`\r\n    INSERT INTO visitors (name, id_number, mobile_number, visit_date, visit_time, purpose, signature)\r\n    VALUES (?, ?, ?, ?, ?, ?, ?)\r\n  `);\r\n\r\n    const now = new Date();\r\n    const date = now.toISOString().split('T')[0]; // YYYY-MM-DD\r\n    const time = now.toLocaleTimeString('en-US', { hour12: false });\r\n\r\n    try {\r\n        const result = stmt.run(\r\n            data.name,\r\n            data.idNumber,\r\n            data.mobileNumber,\r\n            date,\r\n            time,\r\n            data.purpose,\r\n            data.signature\r\n        );\r\n\r\n        revalidatePath('/');\r\n        return { success: true, id: result.lastInsertRowid };\r\n    } catch (error) {\r\n        console.error('Failed to save visitor:', error);\r\n        return { success: false, error: 'Failed to save data' };\r\n    }\r\n}\r\n\r\nexport async function getVisitors(date?: string) {\r\n    // If no date provided, default to today's date\r\n    const targetDate = date || new Date().toISOString().split('T')[0];\r\n\r\n    try {\r\n        const stmt = db.prepare('SELECT * FROM visitors WHERE visit_date = ? ORDER BY id DESC');\r\n        const visitors = stmt.all(targetDate) as any[]; // Type as needed\r\n        return { success: true, data: visitors };\r\n    } catch (error) {\r\n        console.error('Failed to get visitors:', error);\r\n        return { success: false, error: 'Failed to fetch data' };\r\n    }\r\n}\r\n\r\nexport async function getSchoolInfo() {\r\n    try {\r\n        const keys = ['school_country', 'school_ministry', 'school_directorate', 'school_name', 'sms_api_key', 'sms_sender_name', 'enable_otp'];\r\n        const placeholders = keys.map(() => '?').join(',');\r\n        const stmt = db.prepare(`SELECT key, value FROM settings WHERE key IN (${placeholders})`);\r\n        const results = stmt.all(...keys) as { key: string; value: string }[];\r\n\r\n        const info: Record<string, string> = {};\r\n        results.forEach(r => {\r\n            info[r.key] = r.value;\r\n        });\r\n\r\n        return { success: true, data: info };\r\n    } catch (error) {\r\n        console.error('Failed to get school info:', error);\r\n        return { success: false, error: 'Failed to fetch info' };\r\n    }\r\n}\r\n\r\n// Existing import modification\r\nimport * as XLSX from 'xlsx';\r\n\r\n// ... (keep existing functions, I will just append new ones for now, but better to do it cleanly)\r\n\r\nexport async function importStudents(formData: FormData) {\r\n    const file = formData.get('file') as File;\r\n    if (!file) return { success: false, error: 'No file uploaded' };\r\n\r\n    try {\r\n        const bytes = await file.arrayBuffer();\r\n        const buffer = Buffer.from(bytes);\r\n        const workbook = XLSX.read(buffer, { type: 'buffer' });\r\n        const sheetName = workbook.SheetNames[0];\r\n        const sheet = workbook.Sheets[sheetName];\r\n        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });\r\n\r\n        // Expected columns: Name, Grade, Class, ID Number, Mobile\r\n        // Assuming header row exists, start from index 1. If not, check data.\r\n        // Let's assume row 0 is header.\r\n\r\n        const stmt = db.prepare(`\r\n            INSERT INTO students (name, grade, class_name, id_number, mobile_number)\r\n            VALUES (?, ?, ?, ?, ?)\r\n        `);\r\n\r\n        // Use transaction for bulk insert\r\n        const insertMany = db.transaction((rows) => {\r\n            for (const row of rows) {\r\n                // row is array [Name, Grade, Class, ID, Mobile]\r\n                // Be careful with index if header exists\r\n                if (!row[0] || !row[3]) continue; // Skip empty rows or missing mandatory fields\r\n                try {\r\n                    stmt.run(row[0], row[1], row[2], String(row[3]), String(row[4]));\r\n                } catch (e) {\r\n                    console.log('Skipping duplicate or invalid row:', row);\r\n                }\r\n            }\r\n        });\r\n\r\n        // Skip first row (headers)\r\n        const dataRows = jsonData.slice(1);\r\n        insertMany(dataRows);\r\n\r\n        return { success: true, count: dataRows.length };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Failed to process file' };\r\n    }\r\n}\r\n\r\n// ... (existing code)\r\n\r\nexport async function getAllStudents() {\r\n    try {\r\n        const stmt = db.prepare('SELECT * FROM students ORDER BY grade, class_name, name');\r\n        const students = stmt.all();\r\n        return { success: true, data: students };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Failed to fetch students' };\r\n    }\r\n}\r\n\r\nexport async function searchStudents(filters: { name?: string, grade?: string, class_name?: string, id_number?: string, mobile_number?: string }) {\r\n    try {\r\n        let sql = 'SELECT * FROM students WHERE 1=1';\r\n        const params: any[] = [];\r\n\r\n        if (filters.name?.trim()) {\r\n            sql += ' AND name LIKE ?';\r\n            params.push(`%${filters.name.trim()}%`);\r\n        }\r\n        if (filters.grade?.trim()) {\r\n            sql += ' AND grade LIKE ?';\r\n            params.push(`%${filters.grade.trim()}%`);\r\n        }\r\n        if (filters.class_name?.trim()) {\r\n            sql += ' AND class_name LIKE ?';\r\n            params.push(`%${filters.class_name.trim()}%`);\r\n        }\r\n        if (filters.id_number?.trim()) {\r\n            sql += ' AND id_number LIKE ?';\r\n            params.push(`%${filters.id_number.trim()}%`);\r\n        }\r\n        if (filters.mobile_number?.trim()) {\r\n            sql += ' AND mobile_number LIKE ?';\r\n            params.push(`%${filters.mobile_number.trim()}%`);\r\n        }\r\n\r\n        sql += ' LIMIT 20';\r\n\r\n        const stmt = db.prepare(sql);\r\n        const students = stmt.all(...params);\r\n        return { success: true, data: students };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Search failed' };\r\n    }\r\n}\r\n\r\nexport async function createExitPermit(studentId: number, reason: string, authorizer: string) {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            INSERT INTO student_exits (student_id, reason, authorizer)\r\n            VALUES (?, ?, ?)\r\n        `);\r\n        stmt.run(studentId, reason, authorizer);\r\n        revalidatePath('/admin/exit-permit');\r\n        revalidatePath('/guard');\r\n        return { success: true };\r\n    } catch (e) {\r\n        return { success: false, error: 'Failed to create permit' };\r\n    }\r\n}\r\n\r\nexport async function getExitPermits(status = 'PENDING') {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            SELECT e.*, s.name as student_name, s.grade, s.class_name \r\n            FROM student_exits e\r\n            JOIN students s ON e.student_id = s.id\r\n            WHERE e.status = ?\r\n            ORDER BY e.request_time DESC\r\n        `);\r\n        const permits = stmt.all(status);\r\n        return { success: true, data: permits };\r\n    } catch (e) {\r\n        return { success: false, error: 'Fetch failed' };\r\n    }\r\n}\r\n\r\nexport async function confirmExitPermit(id: number) {\r\n    try {\r\n        const stmt = db.prepare(`\r\n            UPDATE student_exits \r\n            SET status = 'EXITED', exit_time = CURRENT_TIMESTAMP\r\n            WHERE id = ?\r\n        `);\r\n        const info = stmt.run(id);\r\n        console.log('Confirm Permit ID:', id, 'Changes:', info.changes);\r\n        if (info.changes === 0) return { success: false, error: 'Permit not found' };\r\n        revalidatePath('/guard');\r\n        revalidatePath('/admin/exit-permit');\r\n        return { success: true };\r\n    } catch (e) {\r\n        return { success: false, error: 'Update failed' };\r\n    }\r\n}\r\n\r\nexport async function getStudentExitReport(date?: string) {\r\n    const targetDate = date || new Date().toISOString().split('T')[0];\r\n    try {\r\n        // Get exits for the day\r\n        const stmt = db.prepare(`\r\n            SELECT e.*, s.name, s.grade, s.class_name, s.id_number\r\n            FROM student_exits e\r\n            JOIN students s ON e.student_id = s.id\r\n            WHERE date(e.exit_time) = ? AND e.status = 'EXITED'\r\n            ORDER BY e.exit_time DESC\r\n        `);\r\n\r\n        const exits = stmt.all(targetDate) as any[];\r\n\r\n        // Calculate cumulative count for each student in the list\r\n        // Could be optimized, but simpler to query individually or group by\r\n\r\n        const exitsWithCount = await Promise.all(exits.map(async (exit) => {\r\n            const countStmt = db.prepare(`\r\n                SELECT COUNT(*) as count FROM student_exits \r\n                WHERE student_id = ? AND status = 'EXITED'\r\n            `);\r\n            const countRes = countStmt.get(exit.student_id) as { count: number };\r\n            return { ...exit, cumulative_count: countRes.count };\r\n        }));\r\n\r\n        return { success: true, data: exitsWithCount };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'Report failed' };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MA4TsB,yBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,yDAAA"}},
    {"offset": {"line": 105, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/app/reports/report.module.css [app-client] (css module)"],"sourcesContent":["__turbopack_context__.v({\n  \"actionBtn\": \"report-module__PKjUfW__actionBtn\",\n  \"activeTab\": \"report-module__PKjUfW__activeTab\",\n  \"cardPadding\": \"report-module__PKjUfW__cardPadding\",\n  \"container\": \"report-module__PKjUfW__container\",\n  \"contentCard\": \"report-module__PKjUfW__contentCard\",\n  \"dangerBtn\": \"report-module__PKjUfW__dangerBtn\",\n  \"dateInput\": \"report-module__PKjUfW__dateInput\",\n  \"errorMsg\": \"report-module__PKjUfW__errorMsg\",\n  \"fadeIn\": \"report-module__PKjUfW__fadeIn\",\n  \"filterGrid\": \"report-module__PKjUfW__filterGrid\",\n  \"formGroup\": \"report-module__PKjUfW__formGroup\",\n  \"headerLogo\": \"report-module__PKjUfW__headerLogo\",\n  \"inputText\": \"report-module__PKjUfW__inputText\",\n  \"label\": \"report-module__PKjUfW__label\",\n  \"logoContainer\": \"report-module__PKjUfW__logoContainer\",\n  \"messageBox\": \"report-module__PKjUfW__messageBox\",\n  \"no-print\": \"report-module__PKjUfW__no-print\",\n  \"primaryBtn\": \"report-module__PKjUfW__primaryBtn\",\n  \"reportTitle\": \"report-module__PKjUfW__reportTitle\",\n  \"schoolInfo\": \"report-module__PKjUfW__schoolInfo\",\n  \"secondaryBtn\": \"report-module__PKjUfW__secondaryBtn\",\n  \"selectInput\": \"report-module__PKjUfW__selectInput\",\n  \"separator\": \"report-module__PKjUfW__separator\",\n  \"sigPad\": \"report-module__PKjUfW__sigPad\",\n  \"signatureImg\": \"report-module__PKjUfW__signatureImg\",\n  \"studentItem\": \"report-module__PKjUfW__studentItem\",\n  \"studentList\": \"report-module__PKjUfW__studentList\",\n  \"successMsg\": \"report-module__PKjUfW__successMsg\",\n  \"tabBtn\": \"report-module__PKjUfW__tabBtn\",\n  \"table\": \"report-module__PKjUfW__table\",\n  \"tableWrapper\": \"report-module__PKjUfW__tableWrapper\",\n  \"tabsContainer\": \"report-module__PKjUfW__tabsContainer\",\n  \"title\": \"report-module__PKjUfW__title\",\n  \"toolbar\": \"report-module__PKjUfW__toolbar\",\n  \"topHeader\": \"report-module__PKjUfW__topHeader\",\n});\n"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA"}},
    {"offset": {"line": 146, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MJD8/OneDrive/Desktop/projects/visit/src/app/auth-actions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { db } from '@/lib/db';\r\nimport { cookies } from 'next/headers';\r\nimport { SignJWT, jwtVerify } from 'jose';\r\nimport { redirect } from 'next/navigation';\r\n\r\nconst JWT_SECRET = new TextEncoder().encode('your-secret-key-change-it-in-prod');\r\n\r\nexport async function login(password: string) {\r\n    console.log('[Login Debug] Attempting login...');\r\n    const stmt = db.prepare(\"SELECT value FROM settings WHERE key = 'admin_password'\");\r\n    const result = stmt.get() as { value: string };\r\n\r\n    console.log('[Login Debug] DB Password exists:', !!result);\r\n    // console.log('[Login Debug] Password match:', result?.value === password); // Hidden for security in logs\r\n\r\n    if (result && result.value === password) {\r\n        console.log('[Login Debug] Password correct. Generating token...');\r\n        // Create JWT\r\n        const token = await new SignJWT({ role: 'admin' })\r\n            .setProtectedHeader({ alg: 'HS256' })\r\n            .setIssuedAt()\r\n            .setExpirationTime('24h')\r\n            .sign(JWT_SECRET);\r\n\r\n        console.log('[Login Debug] Setting cookie...');\r\n        (await cookies()).set('admin_token', token, {\r\n            httpOnly: true,\r\n            secure: true, // Always secure on HTTPS\r\n            sameSite: 'lax', // Relaxed from 'strict' to avoid redirection issues\r\n            maxAge: 60 * 60 * 24, // 1 day\r\n        });\r\n\r\n        return { success: true };\r\n    }\r\n\r\n    console.log('[Login Debug] Password incorrect');\r\n    return { success: false, error: 'كلمة المرور غير صحيحة' };\r\n}\r\n\r\nexport async function logout() {\r\n    (await cookies()).delete('admin_token');\r\n    redirect('/login');\r\n}\r\n\r\nexport async function changePassword(currentPassword: string, newPassword: string) {\r\n    // Verify current password\r\n    const stmt = db.prepare(\"SELECT value FROM settings WHERE key = 'admin_password'\");\r\n    const result = stmt.get() as { value: string };\r\n\r\n    if (!result || result.value !== currentPassword) {\r\n        return { success: false, error: 'كلمة المرور الحالية غير صحيحة' };\r\n    }\r\n\r\n    // Update password\r\n    const updateStmt = db.prepare(\"UPDATE settings SET value = ? WHERE key = 'admin_password'\");\r\n    updateStmt.run(newPassword);\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport async function verifySession() {\r\n    const cookieStore = await cookies();\r\n    const token = cookieStore.get('admin_token');\r\n\r\n    if (!token) return false;\r\n\r\n    try {\r\n        await jwtVerify(token.value, JWT_SECRET);\r\n        return true;\r\n    } catch (err) {\r\n        return false;\r\n    }\r\n}\r\n\r\nexport async function updateSchoolInfo(info: Record<string, string>) {\r\n    // Check auth first\r\n    const cookieStore = await cookies();\r\n    const token = cookieStore.get('admin_token');\r\n    if (!token) return { success: false, error: 'غير مصرح' };\r\n\r\n    try {\r\n        const stmt = db.prepare(\"INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)\");\r\n        const transaction = db.transaction((data) => {\r\n            for (const [key, value] of Object.entries(data)) {\r\n                if (typeof value === 'string') { // Type guard\r\n                    stmt.run(key, value);\r\n                }\r\n            }\r\n        });\r\n\r\n        transaction(info);\r\n        return { success: true };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'حذث خطأ في التحديث' };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MA8CsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,kDAAA"}},
    {"offset": {"line": 163, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MJD8/OneDrive/Desktop/projects/visit/src/app/auth-actions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { db } from '@/lib/db';\r\nimport { cookies } from 'next/headers';\r\nimport { SignJWT, jwtVerify } from 'jose';\r\nimport { redirect } from 'next/navigation';\r\n\r\nconst JWT_SECRET = new TextEncoder().encode('your-secret-key-change-it-in-prod');\r\n\r\nexport async function login(password: string) {\r\n    console.log('[Login Debug] Attempting login...');\r\n    const stmt = db.prepare(\"SELECT value FROM settings WHERE key = 'admin_password'\");\r\n    const result = stmt.get() as { value: string };\r\n\r\n    console.log('[Login Debug] DB Password exists:', !!result);\r\n    // console.log('[Login Debug] Password match:', result?.value === password); // Hidden for security in logs\r\n\r\n    if (result && result.value === password) {\r\n        console.log('[Login Debug] Password correct. Generating token...');\r\n        // Create JWT\r\n        const token = await new SignJWT({ role: 'admin' })\r\n            .setProtectedHeader({ alg: 'HS256' })\r\n            .setIssuedAt()\r\n            .setExpirationTime('24h')\r\n            .sign(JWT_SECRET);\r\n\r\n        console.log('[Login Debug] Setting cookie...');\r\n        (await cookies()).set('admin_token', token, {\r\n            httpOnly: true,\r\n            secure: true, // Always secure on HTTPS\r\n            sameSite: 'lax', // Relaxed from 'strict' to avoid redirection issues\r\n            maxAge: 60 * 60 * 24, // 1 day\r\n        });\r\n\r\n        return { success: true };\r\n    }\r\n\r\n    console.log('[Login Debug] Password incorrect');\r\n    return { success: false, error: 'كلمة المرور غير صحيحة' };\r\n}\r\n\r\nexport async function logout() {\r\n    (await cookies()).delete('admin_token');\r\n    redirect('/login');\r\n}\r\n\r\nexport async function changePassword(currentPassword: string, newPassword: string) {\r\n    // Verify current password\r\n    const stmt = db.prepare(\"SELECT value FROM settings WHERE key = 'admin_password'\");\r\n    const result = stmt.get() as { value: string };\r\n\r\n    if (!result || result.value !== currentPassword) {\r\n        return { success: false, error: 'كلمة المرور الحالية غير صحيحة' };\r\n    }\r\n\r\n    // Update password\r\n    const updateStmt = db.prepare(\"UPDATE settings SET value = ? WHERE key = 'admin_password'\");\r\n    updateStmt.run(newPassword);\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport async function verifySession() {\r\n    const cookieStore = await cookies();\r\n    const token = cookieStore.get('admin_token');\r\n\r\n    if (!token) return false;\r\n\r\n    try {\r\n        await jwtVerify(token.value, JWT_SECRET);\r\n        return true;\r\n    } catch (err) {\r\n        return false;\r\n    }\r\n}\r\n\r\nexport async function updateSchoolInfo(info: Record<string, string>) {\r\n    // Check auth first\r\n    const cookieStore = await cookies();\r\n    const token = cookieStore.get('admin_token');\r\n    if (!token) return { success: false, error: 'غير مصرح' };\r\n\r\n    try {\r\n        const stmt = db.prepare(\"INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)\");\r\n        const transaction = db.transaction((data) => {\r\n            for (const [key, value] of Object.entries(data)) {\r\n                if (typeof value === 'string') { // Type guard\r\n                    stmt.run(key, value);\r\n                }\r\n            }\r\n        });\r\n\r\n        transaction(info);\r\n        return { success: true };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'حذث خطأ في التحديث' };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MAyCsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,0CAAA"}},
    {"offset": {"line": 180, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MJD8/OneDrive/Desktop/projects/visit/src/app/auth-actions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { db } from '@/lib/db';\r\nimport { cookies } from 'next/headers';\r\nimport { SignJWT, jwtVerify } from 'jose';\r\nimport { redirect } from 'next/navigation';\r\n\r\nconst JWT_SECRET = new TextEncoder().encode('your-secret-key-change-it-in-prod');\r\n\r\nexport async function login(password: string) {\r\n    console.log('[Login Debug] Attempting login...');\r\n    const stmt = db.prepare(\"SELECT value FROM settings WHERE key = 'admin_password'\");\r\n    const result = stmt.get() as { value: string };\r\n\r\n    console.log('[Login Debug] DB Password exists:', !!result);\r\n    // console.log('[Login Debug] Password match:', result?.value === password); // Hidden for security in logs\r\n\r\n    if (result && result.value === password) {\r\n        console.log('[Login Debug] Password correct. Generating token...');\r\n        // Create JWT\r\n        const token = await new SignJWT({ role: 'admin' })\r\n            .setProtectedHeader({ alg: 'HS256' })\r\n            .setIssuedAt()\r\n            .setExpirationTime('24h')\r\n            .sign(JWT_SECRET);\r\n\r\n        console.log('[Login Debug] Setting cookie...');\r\n        (await cookies()).set('admin_token', token, {\r\n            httpOnly: true,\r\n            secure: true, // Always secure on HTTPS\r\n            sameSite: 'lax', // Relaxed from 'strict' to avoid redirection issues\r\n            maxAge: 60 * 60 * 24, // 1 day\r\n        });\r\n\r\n        return { success: true };\r\n    }\r\n\r\n    console.log('[Login Debug] Password incorrect');\r\n    return { success: false, error: 'كلمة المرور غير صحيحة' };\r\n}\r\n\r\nexport async function logout() {\r\n    (await cookies()).delete('admin_token');\r\n    redirect('/login');\r\n}\r\n\r\nexport async function changePassword(currentPassword: string, newPassword: string) {\r\n    // Verify current password\r\n    const stmt = db.prepare(\"SELECT value FROM settings WHERE key = 'admin_password'\");\r\n    const result = stmt.get() as { value: string };\r\n\r\n    if (!result || result.value !== currentPassword) {\r\n        return { success: false, error: 'كلمة المرور الحالية غير صحيحة' };\r\n    }\r\n\r\n    // Update password\r\n    const updateStmt = db.prepare(\"UPDATE settings SET value = ? WHERE key = 'admin_password'\");\r\n    updateStmt.run(newPassword);\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport async function verifySession() {\r\n    const cookieStore = await cookies();\r\n    const token = cookieStore.get('admin_token');\r\n\r\n    if (!token) return false;\r\n\r\n    try {\r\n        await jwtVerify(token.value, JWT_SECRET);\r\n        return true;\r\n    } catch (err) {\r\n        return false;\r\n    }\r\n}\r\n\r\nexport async function updateSchoolInfo(info: Record<string, string>) {\r\n    // Check auth first\r\n    const cookieStore = await cookies();\r\n    const token = cookieStore.get('admin_token');\r\n    if (!token) return { success: false, error: 'غير مصرح' };\r\n\r\n    try {\r\n        const stmt = db.prepare(\"INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)\");\r\n        const transaction = db.transaction((data) => {\r\n            for (const [key, value] of Object.entries(data)) {\r\n                if (typeof value === 'string') { // Type guard\r\n                    stmt.run(key, value);\r\n                }\r\n            }\r\n        });\r\n\r\n        transaction(info);\r\n        return { success: true };\r\n    } catch (e) {\r\n        console.error(e);\r\n        return { success: false, error: 'حذث خطأ في التحديث' };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MA4EsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,oDAAA"}},
    {"offset": {"line": 196, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/components/Settings.module.css [app-client] (css module)"],"sourcesContent":["__turbopack_context__.v({\n  \"activeTab\": \"Settings-module__S5UUbq__activeTab\",\n  \"closeBtn\": \"Settings-module__S5UUbq__closeBtn\",\n  \"divider\": \"Settings-module__S5UUbq__divider\",\n  \"form\": \"Settings-module__S5UUbq__form\",\n  \"input\": \"Settings-module__S5UUbq__input\",\n  \"logoutBtn\": \"Settings-module__S5UUbq__logoutBtn\",\n  \"modal\": \"Settings-module__S5UUbq__modal\",\n  \"msg\": \"Settings-module__S5UUbq__msg\",\n  \"overlay\": \"Settings-module__S5UUbq__overlay\",\n  \"tab\": \"Settings-module__S5UUbq__tab\",\n  \"tabs\": \"Settings-module__S5UUbq__tabs\",\n  \"updateBtn\": \"Settings-module__S5UUbq__updateBtn\",\n});\n"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA"}},
    {"offset": {"line": 214, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MJD8/OneDrive/Desktop/projects/visit/src/components/SettingsModal.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { changePassword, logout, updateSchoolInfo } from '@/app/auth-actions';\r\nimport { getSchoolInfo } from '@/app/actions';\r\nimport styles from './Settings.module.css';\r\n\r\nexport default function SettingsModal({ onClose }: { onClose: () => void }) {\r\n    const [activeTab, setActiveTab] = useState<'password' | 'school' | 'sms'>('school');\r\n\r\n    // Password state\r\n    const [currentPassword, setCurrentPassword] = useState('');\r\n    const [newPassword, setNewPassword] = useState('');\r\n\r\n    // School Info state\r\n    const [schoolInfo, setSchoolInfo] = useState({\r\n        school_country: '',\r\n        school_ministry: '',\r\n        school_directorate: '',\r\n        school_name: ''\r\n    });\r\n\r\n    // SMS Settings state\r\n    const [smsSettings, setSmsSettings] = useState({\r\n        sms_api_key: '',\r\n        sms_sender_name: '',\r\n        enable_otp: 'true' // Default to true, stored as string\r\n    });\r\n\r\n    const [message, setMessage] = useState('');\r\n\r\n    useEffect(() => {\r\n        // Load school info and SMS settings\r\n        getSchoolInfo().then(res => {\r\n            if (res.success && res.data) {\r\n                setSchoolInfo({\r\n                    school_country: res.data.school_country || '',\r\n                    school_ministry: res.data.school_ministry || '',\r\n                    school_directorate: res.data.school_directorate || '',\r\n                    school_name: res.data.school_name || ''\r\n                });\r\n                setSmsSettings({\r\n                    sms_api_key: res.data.sms_api_key || '',\r\n                    sms_sender_name: res.data.sms_sender_name || '',\r\n                    enable_otp: res.data.enable_otp ?? 'true'\r\n                });\r\n            }\r\n        });\r\n    }, []);\r\n\r\n    const handleChangePassword = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        const res = await changePassword(currentPassword, newPassword);\r\n        if (res.success) {\r\n            setMessage('تم تغيير كلمة المرور بنجاح');\r\n            setCurrentPassword('');\r\n            setNewPassword('');\r\n        } else {\r\n            setMessage(res.error || 'حدث خطأ');\r\n        }\r\n    };\r\n\r\n    const handleUpdateSchoolInfo = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        const res = await updateSchoolInfo(schoolInfo);\r\n        if (res.success) {\r\n            setMessage('تم حفظ المعلومات بنجاح');\r\n        } else {\r\n            setMessage(res.error || 'حدث خطأ في الحفظ');\r\n        }\r\n    };\r\n\r\n    const handleUpdateSmsSettings = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        const res = await updateSchoolInfo(smsSettings); // Reuse the same update function as it works for any settings key\r\n        if (res.success) {\r\n            setMessage('تم حفظ إعدادات الرسائل بنجاح');\r\n        } else {\r\n            setMessage(res.error || 'حدث خطأ في الحفظ');\r\n        }\r\n    };\r\n\r\n    const handleLogout = async () => {\r\n        await logout();\r\n    };\r\n\r\n    return (\r\n        <div className={styles.overlay} dir=\"rtl\">\r\n            <div className={styles.modal}>\r\n                <button onClick={onClose} className={styles.closeBtn}>✕</button>\r\n                <h2 style={{ marginBottom: '1rem' }}>الإعدادات</h2>\r\n\r\n                <div className={styles.tabs}>\r\n                    <button\r\n                        className={`${styles.tab} ${activeTab === 'school' ? styles.activeTab : ''}`}\r\n                        onClick={() => { setActiveTab('school'); setMessage(''); }}\r\n                    >\r\n                        بيانات المدرسة\r\n                    </button>\r\n                    <button\r\n                        className={`${styles.tab} ${activeTab === 'sms' ? styles.activeTab : ''}`}\r\n                        onClick={() => { setActiveTab('sms'); setMessage(''); }}\r\n                    >\r\n                        إعدادات الرسائل\r\n                    </button>\r\n                    <button\r\n                        className={`${styles.tab} ${activeTab === 'password' ? styles.activeTab : ''}`}\r\n                        onClick={() => { setActiveTab('password'); setMessage(''); }}\r\n                    >\r\n                        كلمة المرور\r\n                    </button>\r\n                </div>\r\n\r\n                {activeTab === 'password' ? (\r\n                    <form onSubmit={handleChangePassword} className={styles.form}>\r\n                        <input\r\n                            type=\"password\"\r\n                            placeholder=\"كلمة المرور الحالية\"\r\n                            value={currentPassword}\r\n                            onChange={(e) => setCurrentPassword(e.target.value)}\r\n                            className={styles.input}\r\n                        />\r\n                        <input\r\n                            type=\"password\"\r\n                            placeholder=\"كلمة المرور الجديدة\"\r\n                            value={newPassword}\r\n                            onChange={(e) => setNewPassword(e.target.value)}\r\n                            className={styles.input}\r\n                        />\r\n                        <button type=\"submit\" className={styles.updateBtn}>تحديث كلمة المرور</button>\r\n                    </form>\r\n                ) : activeTab === 'sms' ? (\r\n                    <form onSubmit={handleUpdateSmsSettings} className={styles.form}>\r\n                        <div style={{ display: 'flex', alignItems: 'center', marginBottom: '1rem', gap: '0.5rem' }}>\r\n                            <input\r\n                                type=\"checkbox\"\r\n                                id=\"enableOtp\"\r\n                                checked={smsSettings.enable_otp === 'true'}\r\n                                onChange={(e) => setSmsSettings({ ...smsSettings, enable_otp: e.target.checked ? 'true' : 'false' })}\r\n                                style={{ width: 'auto' }}\r\n                            />\r\n                            <label htmlFor=\"enableOtp\" style={{ fontWeight: 'bold' }}>تفعيل التحقق برسالة نصية (OTP)</label>\r\n                        </div>\r\n\r\n                        <label style={{ fontWeight: 'bold' }}>مفتاح API</label>\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"API Key\"\r\n                            value={smsSettings.sms_api_key}\r\n                            onChange={(e) => setSmsSettings({ ...smsSettings, sms_api_key: e.target.value })}\r\n                            className={styles.input}\r\n                        />\r\n                        <label style={{ fontWeight: 'bold' }}>اسم المرسل (Sender Name)</label>\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"الاسم المسجل (مثل: School1)\"\r\n                            value={smsSettings.sms_sender_name}\r\n                            onChange={(e) => setSmsSettings({ ...smsSettings, sms_sender_name: e.target.value })}\r\n                            className={styles.input}\r\n                        />\r\n                        <button type=\"submit\" className={styles.updateBtn}>حفظ الإعدادات</button>\r\n                        <p style={{ fontSize: '0.8rem', color: 'var(--text-muted)' }}>\r\n                            ملاحظة: اسم المرسل يجب أن يكون مفعلاً ومعتمداً من مزود الخدمة.\r\n                        </p>\r\n                    </form>\r\n                ) : (\r\n                    <form onSubmit={handleUpdateSchoolInfo} className={styles.form}>\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"الدولة (المملكة العربية السعودية)\"\r\n                            value={schoolInfo.school_country}\r\n                            onChange={(e) => setSchoolInfo({ ...schoolInfo, school_country: e.target.value })}\r\n                            className={styles.input}\r\n                        />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"الوزارة (وزارة التعليم)\"\r\n                            value={schoolInfo.school_ministry}\r\n                            onChange={(e) => setSchoolInfo({ ...schoolInfo, school_ministry: e.target.value })}\r\n                            className={styles.input}\r\n                        />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"الإدارة (الإدارة العامة...)\"\r\n                            value={schoolInfo.school_directorate}\r\n                            onChange={(e) => setSchoolInfo({ ...schoolInfo, school_directorate: e.target.value })}\r\n                            className={styles.input}\r\n                        />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"اسم المدرسة\"\r\n                            value={schoolInfo.school_name}\r\n                            onChange={(e) => setSchoolInfo({ ...schoolInfo, school_name: e.target.value })}\r\n                            className={styles.input}\r\n                        />\r\n                        <button type=\"submit\" className={styles.updateBtn}>حفظ المعلومات</button>\r\n                    </form>\r\n                )}\r\n\r\n                {message && <p className={styles.msg}>{message}</p>}\r\n\r\n                <hr className={styles.divider} />\r\n\r\n                <button onClick={handleLogout} className={styles.logoutBtn}>تسجيل الخروج</button>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 656, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/MJD8/OneDrive/Desktop/projects/visit/src/app/reports/page.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect, useMemo, useRef } from 'react';\r\nimport { getVisitors, getSchoolInfo, searchStudents, createExitPermit, importStudents, getAllStudents, getStudentExitReport } from '@/app/actions';\r\nimport SignatureCanvas from 'react-signature-canvas';\r\nimport styles from './report.module.css';\r\nimport Link from 'next/link';\r\nimport SettingsModal from '@/components/SettingsModal';\r\nimport Image from 'next/image';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\ntype Tab = 'visitors' | 'permit' | 'student_report' | 'import';\r\n\r\nexport default function AdminDashboard() {\r\n    const [activeTab, setActiveTab] = useState<Tab>('visitors');\r\n    const [schoolInfo, setSchoolInfo] = useState<Record<string, string> | null>(null);\r\n    const [showSettings, setShowSettings] = useState(false);\r\n\r\n    // --- Visitor Report State ---\r\n    const [visitorDate, setVisitorDate] = useState(new Date().toISOString().split('T')[0]);\r\n    const [visitors, setVisitors] = useState<any[]>([]);\r\n    const [visitorLoading, setVisitorLoading] = useState(false);\r\n\r\n    // --- Student Exit Report State ---\r\n    const [studentReportDate, setStudentReportDate] = useState(new Date().toISOString().split('T')[0]);\r\n    const [studentReportData, setStudentReportData] = useState<any[]>([]);\r\n\r\n    // --- Student Permit Logic State ---\r\n    const [allStudents, setAllStudents] = useState<any[]>([]);\r\n    const [students, setStudents] = useState<any[]>([]); // Displayed students\r\n    const [selectedStudent, setSelectedStudent] = useState<any>(null);\r\n    const [permitLoading, setPermitLoading] = useState(false);\r\n    const [permitMessage, setPermitMessage] = useState('');\r\n    const [reason, setReason] = useState('');\r\n\r\n    // Canvas Ref\r\n    const sigCanvas = useRef<any>(null);\r\n\r\n    const [filters, setFilters] = useState({\r\n        name: '',\r\n        grade: '',\r\n        class_name: '',\r\n        id_number: '',\r\n        mobile_number: ''\r\n    });\r\n\r\n    // --- Import Logic State ---\r\n    const [importStatus, setImportStatus] = useState<string>('');\r\n    const [importLoading, setImportLoading] = useState(false);\r\n\r\n    // --- Effects ---\r\n\r\n    // 1. Fetch School Info\r\n    useEffect(() => {\r\n        getSchoolInfo().then(res => {\r\n            if (res.success && res.data) {\r\n                setSchoolInfo(res.data);\r\n            }\r\n        });\r\n    }, []);\r\n\r\n    // 2. Fetch Visitors when tab is 'visitors' or date changes\r\n    useEffect(() => {\r\n        if (activeTab === 'visitors') {\r\n            setVisitorLoading(true);\r\n            getVisitors(visitorDate).then(res => {\r\n                if (res.success) setVisitors(res.data || []);\r\n                setVisitorLoading(false);\r\n            });\r\n        }\r\n    }, [visitorDate, activeTab]);\r\n\r\n    // 3. Fetch Student Report when tab is 'student_report' or date changes\r\n    useEffect(() => {\r\n        if (activeTab === 'student_report') {\r\n            getStudentExitReport(studentReportDate).then(res => {\r\n                if (res.success) setStudentReportData(res.data || []);\r\n            });\r\n        }\r\n    }, [studentReportDate, activeTab]);\r\n\r\n    // 4. Fetch All Students for Permit Logic (load once)\r\n    useEffect(() => {\r\n        // Load students if we are in permit tab and haven't loaded yet, or just load once\r\n        // To ensure dropdowns are populated\r\n        if (allStudents.length === 0) {\r\n            getAllStudents().then(res => {\r\n                if (res.success) setAllStudents(res.data || []);\r\n            });\r\n        }\r\n    }, []);\r\n\r\n    // --- Derived Options for Permit Filters ---\r\n    const availableStudents = useMemo(() => {\r\n        return allStudents.filter((s: any) => {\r\n            if (filters.grade && s.grade !== filters.grade) return false;\r\n            if (filters.class_name && s.class_name !== filters.class_name) return false;\r\n            if (filters.name && s.name !== filters.name) return false;\r\n            if (filters.id_number && s.id_number !== filters.id_number) return false;\r\n            if (filters.mobile_number && s.mobile_number !== filters.mobile_number) return false;\r\n            return true;\r\n        });\r\n    }, [allStudents, filters]);\r\n\r\n    const gradeOptions = useMemo(() => [...new Set(allStudents.map((s: any) => s.grade).filter(Boolean))] as string[], [allStudents]);\r\n\r\n    const classOptions = useMemo(() => {\r\n        const base = filters.grade ? allStudents.filter((s: any) => s.grade === filters.grade) : allStudents;\r\n        return [...new Set(base.map((s: any) => s.class_name).filter(Boolean))] as string[];\r\n    }, [allStudents, filters.grade]);\r\n\r\n    const nameOptions = useMemo(() => {\r\n        const base = allStudents.filter((s: any) => {\r\n            if (filters.grade && s.grade !== filters.grade) return false;\r\n            if (filters.class_name && s.class_name !== filters.class_name) return false;\r\n            return true;\r\n        });\r\n        return [...new Set(base.map((s: any) => s.name).filter(Boolean))] as string[];\r\n    }, [allStudents, filters.grade, filters.class_name]);\r\n\r\n    const idOptions = useMemo(() => {\r\n        const base = allStudents.filter((s: any) => {\r\n            if (filters.grade && s.grade !== filters.grade) return false;\r\n            if (filters.class_name && s.class_name !== filters.class_name) return false;\r\n            if (filters.name && s.name !== filters.name) return false;\r\n            return true;\r\n        });\r\n        return [...new Set(base.map((s: any) => s.id_number).filter(Boolean))] as string[];\r\n    }, [allStudents, filters.grade, filters.class_name, filters.name]);\r\n\r\n    const mobileOptions = useMemo(() => {\r\n        const base = allStudents.filter((s: any) => {\r\n            if (filters.grade && s.grade !== filters.grade) return false;\r\n            if (filters.class_name && s.class_name !== filters.class_name) return false;\r\n            if (filters.name && s.name !== filters.name) return false;\r\n            if (filters.id_number && s.id_number !== filters.id_number) return false;\r\n            return true;\r\n        });\r\n        return [...new Set(base.map((s: any) => s.mobile_number).filter(Boolean))] as string[];\r\n    }, [allStudents, filters.grade, filters.class_name, filters.name, filters.id_number]);\r\n\r\n\r\n    // --- Handlers ---\r\n    const handlePrint = () => {\r\n        window.print();\r\n    };\r\n\r\n    const handleFilterChange = (field: string, value: string) => {\r\n        setFilters(prev => ({ ...prev, [field]: value }));\r\n    };\r\n\r\n    const handleSearchSubmit = (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        setStudents(availableStudents);\r\n        setSelectedStudent(null);\r\n    };\r\n\r\n    const handleSelectStudent = (student: any) => {\r\n        setSelectedStudent(student);\r\n        setStudents([]); // Clear list after selection\r\n        // Reset filters for cleanliness? Or keep them?\r\n        // Let's keep filters\r\n    };\r\n\r\n    const handlePermitSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (!selectedStudent) return;\r\n\r\n        if (sigCanvas.current.isEmpty()) {\r\n            alert('الرجاء توقيع المسؤول');\r\n            return;\r\n        }\r\n        const authorizerSignature = sigCanvas.current.toDataURL();\r\n\r\n        setPermitLoading(true);\r\n        const res = await createExitPermit(selectedStudent.id, reason, authorizerSignature);\r\n        if (res.success) {\r\n            setPermitMessage('تم إرسال الطلب بنجاح إلى حارس الأمن');\r\n            setSelectedStudent(null);\r\n            setReason('');\r\n            sigCanvas.current.clear();\r\n            setTimeout(() => setPermitMessage(''), 5000);\r\n        } else {\r\n            setPermitMessage('حدث خطأ أثناء إرسال الطلب');\r\n        }\r\n        setPermitLoading(false);\r\n    };\r\n\r\n    const handleImportSubmit = async (e: React.FormEvent<HTMLFormElement>) => {\r\n        e.preventDefault();\r\n        setImportLoading(true);\r\n        setImportStatus('');\r\n        const formData = new FormData(e.currentTarget);\r\n        const res = await importStudents(formData);\r\n        if (res.success) {\r\n            setImportStatus(`تم استيراد ${res.count} طالب بنجاح`);\r\n            // Refresh students\r\n            getAllStudents().then(r => { if (r.success) setAllStudents(r.data || []) });\r\n        } else {\r\n            setImportStatus(`حدث خطأ: ${res.error}`);\r\n        }\r\n        setImportLoading(false);\r\n    };\r\n\r\n    // --- Dynamic Title Logic ---\r\n    const getPageTitle = () => {\r\n        switch (activeTab) {\r\n            case 'visitors': return 'تقرير الزوار اليومي';\r\n            case 'permit': return 'إصدار إذن خروج طالب';\r\n            case 'student_report': return 'سجل الاستئذان اليومي';\r\n            case 'import': return 'استيراد بيانات الطلاب';\r\n            default: return 'لوحة التحكم';\r\n        }\r\n    };\r\n\r\n    const getPageDate = () => {\r\n        switch (activeTab) {\r\n            case 'visitors': return visitorDate;\r\n            case 'student_report': return studentReportDate;\r\n            default: return new Date().toISOString().split('T')[0];\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className={styles.container} dir=\"rtl\">\r\n            {showSettings && <SettingsModal onClose={() => setShowSettings(false)} />}\r\n\r\n            {/* Header */}\r\n            <header className={styles.topHeader}>\r\n                {schoolInfo && (\r\n                    <div className={styles.schoolInfo}>\r\n                        <p>{schoolInfo.school_country}</p>\r\n                        <p>{schoolInfo.school_ministry}</p>\r\n                        <p>{schoolInfo.school_directorate}</p>\r\n                        <p>{schoolInfo.school_name}</p>\r\n                    </div>\r\n                )}\r\n                <div className={styles.logoContainer}>\r\n                    <Image src=\"/logo_green.png\" alt=\"Logo\" width={110} height={110} className={styles.headerLogo} priority />\r\n                </div>\r\n                <div className={styles.reportTitle}>\r\n                    <h1 className={styles.title}>{getPageTitle()}</h1>\r\n                    {(activeTab === 'visitors' || activeTab === 'student_report') && (\r\n                        <p>{new Date(getPageDate()).toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>\r\n                    )}\r\n                </div>\r\n            </header>\r\n\r\n            {/* Navigation Tabs (Hidden in Print) */}\r\n            <div className={`no-print ${styles.tabsContainer}`}>\r\n                <button\r\n                    onClick={() => setActiveTab('visitors')}\r\n                    className={`${styles.tabBtn} ${activeTab === 'visitors' ? styles.activeTab : ''}`}\r\n                >\r\n                    سجل الزوار\r\n                </button>\r\n                <div className={styles.separator}></div>\r\n                <button\r\n                    onClick={() => setActiveTab('permit')}\r\n                    className={`${styles.tabBtn} ${activeTab === 'permit' ? styles.activeTab : ''}`}\r\n                >\r\n                    إصدار إذن خروج\r\n                </button>\r\n                <div className={styles.separator}></div>\r\n                <button\r\n                    onClick={() => setActiveTab('student_report')}\r\n                    className={`${styles.tabBtn} ${activeTab === 'student_report' ? styles.activeTab : ''}`}\r\n                >\r\n                    سجل الاستئذان\r\n                </button>\r\n                <div className={styles.separator}></div>\r\n                <button\r\n                    onClick={() => setActiveTab('import')}\r\n                    className={`${styles.tabBtn} ${activeTab === 'import' ? styles.activeTab : ''}`}\r\n                >\r\n                    استيراد الطلاب\r\n                </button>\r\n            </div>\r\n\r\n            {/* Actions Toolbar */}\r\n            <div className={`no-print ${styles.toolbar}`}>\r\n                <div style={{ display: 'flex', gap: '1rem' }}>\r\n                    <Link href=\"/\" className={`${styles.actionBtn} ${styles.secondaryBtn}`}>\r\n                        الرئيسية\r\n                    </Link>\r\n                    <button onClick={() => setShowSettings(true)} className={`${styles.actionBtn} ${styles.secondaryBtn}`}>\r\n                        الإعدادات\r\n                    </button>\r\n                </div>\r\n\r\n                <div className={styles.controls}>\r\n                    {activeTab === 'visitors' && (\r\n                        <input\r\n                            type=\"date\"\r\n                            value={visitorDate}\r\n                            onChange={(e) => setVisitorDate(e.target.value)}\r\n                            className={styles.dateInput}\r\n                        />\r\n                    )}\r\n                    {activeTab === 'student_report' && (\r\n                        <input\r\n                            type=\"date\"\r\n                            value={studentReportDate}\r\n                            onChange={(e) => setStudentReportDate(e.target.value)}\r\n                            className={styles.dateInput}\r\n                        />\r\n                    )}\r\n\r\n                    {(activeTab === 'visitors' || activeTab === 'student_report') && (\r\n                        <button onClick={handlePrint} className={`${styles.actionBtn} ${styles.primaryBtn}`}>\r\n                            طباعة التقرير\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Main Content Area */}\r\n            <div className={styles.contentCard}>\r\n\r\n                {/* 1. Visitors Tab */}\r\n                {activeTab === 'visitors' && (\r\n                    <div className={styles.tableWrapper}>\r\n                        {visitorLoading ? <div className={styles.cardPadding}><p>جاري التحميل...</p></div> :\r\n                            visitors.length === 0 ? <div className={styles.cardPadding}><p>لا يوجد زوار في هذا التاريخ.</p></div> : (\r\n                                <table className={styles.table}>\r\n                                    <thead>\r\n                                        <tr>\r\n                                            <th>الوقت</th>\r\n                                            <th>الاسم</th>\r\n                                            <th>رقم الهوية</th>\r\n                                            <th>الجوال</th>\r\n                                            <th>الغرض</th>\r\n                                            <th>الإقرار</th>\r\n                                            <th>التوقيع</th>\r\n                                        </tr>\r\n                                    </thead>\r\n                                    <tbody>\r\n                                        {visitors.map((visitor) => (\r\n                                            <tr key={visitor.id}>\r\n                                                <td>{visitor.visit_time}</td>\r\n                                                <td>{visitor.name}</td>\r\n                                                <td>{visitor.id_number}</td>\r\n                                                <td>{visitor.mobile_number}</td>\r\n                                                <td>{visitor.purpose}</td>\r\n                                                <td><span style={{ color: 'green', fontWeight: 'bold' }}>تم</span></td>\r\n                                                <td>{visitor.signature && <img src={visitor.signature} alt=\"توقيع\" className={styles.signatureImg} />}</td>\r\n                                            </tr>\r\n                                        ))}\r\n                                    </tbody>\r\n                                </table>\r\n                            )\r\n                        }\r\n                    </div>\r\n                )}\r\n\r\n                {/* 2. Permit Tab */}\r\n                {activeTab === 'permit' && (\r\n                    <div className={styles.cardPadding}>\r\n                        {permitMessage && (\r\n                            <div className={`${styles.messageBox} ${permitMessage.includes('خطأ') ? styles.errorMsg : styles.successMsg}`}>\r\n                                {permitMessage}\r\n                            </div>\r\n                        )}\r\n\r\n                        {!selectedStudent ? (\r\n                            <div>\r\n                                <h3 className={styles.label} style={{ fontSize: '1.2rem', marginBottom: '1.5rem' }}>البحث عن طالب</h3>\r\n                                <form onSubmit={handleSearchSubmit} className={styles.filterGrid}>\r\n                                    <div>\r\n                                        <label className={styles.label} style={{ fontSize: '0.85rem' }}>القف الدراسي</label>\r\n                                        <select className={styles.selectInput} value={filters.grade} onChange={(e) => handleFilterChange('grade', e.target.value)}>\r\n                                            <option value=\"\">كل الصفوف</option>\r\n                                            {gradeOptions.map(g => <option key={g} value={g}>{g}</option>)}\r\n                                        </select>\r\n                                    </div>\r\n                                    <div>\r\n                                        <label className={styles.label} style={{ fontSize: '0.85rem' }}>الفصل</label>\r\n                                        <select className={styles.selectInput} value={filters.class_name} onChange={(e) => handleFilterChange('class_name', e.target.value)}>\r\n                                            <option value=\"\">كل الفصول</option>\r\n                                            {classOptions.map(c => <option key={c} value={c}>{c}</option>)}\r\n                                        </select>\r\n                                    </div>\r\n                                    <div>\r\n                                        <label className={styles.label} style={{ fontSize: '0.85rem' }}>اسم الطالب</label>\r\n                                        <select className={styles.selectInput} value={filters.name} onChange={(e) => handleFilterChange('name', e.target.value)}>\r\n                                            <option value=\"\">كل الطلاب</option>\r\n                                            {nameOptions.map(n => <option key={n} value={n}>{n}</option>)}\r\n                                        </select>\r\n                                    </div>\r\n                                    <div>\r\n                                        <label className={styles.label} style={{ fontSize: '0.85rem' }}>رقم الهوية</label>\r\n                                        <select className={styles.selectInput} value={filters.id_number} onChange={(e) => handleFilterChange('id_number', e.target.value)}>\r\n                                            <option value=\"\">بحث بالهوية</option>\r\n                                            {idOptions.map(id => <option key={id} value={id}>{id}</option>)}\r\n                                        </select>\r\n                                    </div>\r\n                                    <div>\r\n                                        <label className={styles.label} style={{ fontSize: '0.85rem' }}>رقم الجوال</label>\r\n                                        <select className={styles.selectInput} value={filters.mobile_number} onChange={(e) => handleFilterChange('mobile_number', e.target.value)}>\r\n                                            <option value=\"\">بحث بالجوال</option>\r\n                                            {mobileOptions.map(m => <option key={m} value={m}>{m}</option>)}\r\n                                        </select>\r\n                                    </div>\r\n\r\n                                    <button type=\"submit\" className={`${styles.actionBtn} ${styles.primaryBtn}`} style={{ height: '42px', marginTop: 'auto' }}>\r\n                                        بحث\r\n                                    </button>\r\n                                </form>\r\n\r\n                                {students.length > 0 && (\r\n                                    <div style={{ marginTop: '2rem' }}>\r\n                                        <h4 className={styles.label} style={{ marginBottom: '1rem' }}>نتائج البحث ({students.length})</h4>\r\n                                        <ul className={styles.studentList}>\r\n                                            {students.map(s => (\r\n                                                <li key={s.id} onClick={() => handleSelectStudent(s)} className={styles.studentItem}>\r\n                                                    <span><b>{s.name}</b></span>\r\n                                                    <span style={{ color: 'var(--text-muted)' }}>{s.grade} - {s.class_name}</span>\r\n                                                </li>\r\n                                            ))}\r\n                                        </ul>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        ) : (\r\n                            <div style={{ maxWidth: '800px', margin: '0 auto' }}>\r\n                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem', borderBottom: '1px solid var(--border)', paddingBottom: '1rem' }}>\r\n                                    <h3 style={{ fontSize: '1.4rem' }}>إصدار إذن خروج</h3>\r\n                                    <button type=\"button\" onClick={() => setSelectedStudent(null)} className={`${styles.actionBtn} ${styles.secondaryBtn}`} style={{ fontSize: '0.9rem' }}>\r\n                                        تغيير الطالب\r\n                                    </button>\r\n                                </div>\r\n\r\n                                <div style={{ background: '#f8fafc', padding: '1.5rem', borderRadius: 'var(--radius)', marginBottom: '2rem' }}>\r\n                                    <p style={{ margin: '0 0 0.5rem 0', fontSize: '1.1rem' }}><strong>اسم الطالب:</strong> {selectedStudent.name}</p>\r\n                                    <div style={{ display: 'flex', gap: '2rem' }}>\r\n                                        <p style={{ margin: 0, color: 'var(--text-muted)' }}><strong>الصف:</strong> {selectedStudent.grade} - {selectedStudent.class_name}</p>\r\n                                        <p style={{ margin: 0, color: 'var(--text-muted)' }}><strong>رقم الهوية:</strong> {selectedStudent.id_number}</p>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <form onSubmit={handlePermitSubmit}>\r\n                                    <div className={styles.formGroup}>\r\n                                        <label className={styles.label}>سبب الخروج</label>\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            required\r\n                                            value={reason}\r\n                                            onChange={(e) => setReason(e.target.value)}\r\n                                            className={styles.inputText}\r\n                                            placeholder=\"مثال: موعد مستشفى، ظروف عائلية...\"\r\n                                        />\r\n                                    </div>\r\n                                    <div className={styles.formGroup}>\r\n                                        <label className={styles.label}>توقيع المسؤول (الوكيل/المدير)</label>\r\n                                        <div className={styles.sigPad}>\r\n                                            <SignatureCanvas\r\n                                                ref={sigCanvas}\r\n                                                penColor='black'\r\n                                                canvasProps={{ style: { width: '100%', height: '180px' } }}\r\n                                            />\r\n                                        </div>\r\n                                        <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '0.5rem' }}>\r\n                                            <button type=\"button\" onClick={() => sigCanvas.current.clear()} style={{ color: 'red', border: 'none', background: 'transparent', cursor: 'pointer', fontSize: '0.9rem' }}>\r\n                                                مسح التوقيع\r\n                                            </button>\r\n                                        </div>\r\n\r\n                                        <p style={{ color: '#ef4444', marginTop: '1.5rem', fontWeight: 'bold', fontSize: '0.95rem', lineHeight: '1.6', background: '#fee2e2', padding: '1rem', borderRadius: '0.5rem' }}>\r\n                                            ⚠️ يمنع خروج الطالب من المدرسة إلا بحضور ولي الأمر، وذلك حسب لوائح وزارة التعليم.\r\n                                        </p>\r\n                                    </div>\r\n                                    <div style={{ display: 'flex', gap: '1rem' }}>\r\n                                        <button type=\"submit\" disabled={permitLoading} className={`${styles.actionBtn} ${styles.primaryBtn}`} style={{ minWidth: '150px', justifyContent: 'center' }}>\r\n                                            {permitLoading ? 'جاري الإرسال...' : 'اعتماد وإرسال الإذن'}\r\n                                        </button>\r\n                                        <button type=\"button\" onClick={() => setSelectedStudent(null)} className={`${styles.actionBtn} ${styles.secondaryBtn}`} style={{ color: '#ef4444', borderColor: '#fee2e2' }}>\r\n                                            إلغاء\r\n                                        </button>\r\n                                    </div>\r\n                                </form>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {/* 3. Student Report Tab */}\r\n                {activeTab === 'student_report' && (\r\n                    <div className={styles.tableWrapper}>\r\n                        {studentReportData.length === 0 ? <div className={styles.cardPadding}><p>لا توجد تصاريح خروج في هذا التاريخ.</p></div> : (\r\n                            <table className={styles.table}>\r\n                                <thead>\r\n                                    <tr>\r\n                                        <th>م</th>\r\n                                        <th>اسم الطالب</th>\r\n                                        <th>الصف</th>\r\n                                        <th>الفصل</th>\r\n                                        <th>وقت الخروج</th>\r\n                                        <th>السبب</th>\r\n                                        <th>المسؤول</th>\r\n                                        <th>العدد (تراكمي)</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    {studentReportData.map((row, index) => (\r\n                                        <tr key={row.id}>\r\n                                            <td>{index + 1}</td>\r\n                                            <td>{row.name}</td>\r\n                                            <td>{row.grade}</td>\r\n                                            <td>{row.class_name}</td>\r\n                                            <td>{new Date(row.exit_time).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</td>\r\n                                            <td>{row.reason}</td>\r\n                                            <td>\r\n                                                {row.authorizer && row.authorizer.startsWith('data:image') ?\r\n                                                    <img src={row.authorizer} alt=\"Auth\" height={40} style={{ objectFit: 'contain' }} />\r\n                                                    : row.authorizer\r\n                                                }\r\n                                            </td>\r\n                                            <td><span style={{ fontWeight: 'bold', background: '#e2e8f0', padding: '0.2rem 0.5rem', borderRadius: '4px' }}>{row.cumulative_count}</span></td>\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            </table>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {/* 4. Import Tab */}\r\n                {activeTab === 'import' && (\r\n                    <div className={styles.cardPadding}>\r\n                        <div style={{ maxWidth: '600px', margin: '0 auto', textAlign: 'center' }}>\r\n                            <div style={{ marginBottom: '2rem' }}>\r\n                                <h3 style={{ fontSize: '1.5rem', marginBottom: '1rem' }}>استيراد طلاب من Excel</h3>\r\n                                <p style={{ color: 'var(--text-muted)' }}>يمكنك رفع ملف Excel يحتوي على بيانات الطلاب لتحديث قاعدة البيانات.</p>\r\n                                <div style={{ background: '#f1f5f9', padding: '1rem', borderRadius: '0.5rem', marginTop: '1rem', fontSize: '0.9rem', textAlign: 'right' }}>\r\n                                    <strong>الأعمدة المطلوبة:</strong>\r\n                                    <ul style={{ listStyle: 'inside', marginTop: '0.5rem' }}>\r\n                                        <li>اسم الطالب</li>\r\n                                        <li>الصف</li>\r\n                                        <li>الفصل</li>\r\n                                        <li>رقم الهوية</li>\r\n                                        <li>رقم الجوال</li>\r\n                                    </ul>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <form onSubmit={handleImportSubmit} style={{ border: '2px dashed #cbd5e1', padding: '3rem 2rem', borderRadius: '1rem', background: '#f8fafc' }}>\r\n                                <input type=\"file\" name=\"file\" accept=\".xlsx, .xls\" required style={{ display: 'block', margin: '0 auto 2rem auto' }} />\r\n                                <button type=\"submit\" disabled={importLoading} className={`${styles.actionBtn} ${styles.primaryBtn}`} style={{ width: '100%', justifyContent: 'center' }}>\r\n                                    {importLoading ? 'جاري الرفع والمعالجة...' : 'رفع الملف وبدء الاستيراد'}\r\n                                </button>\r\n                            </form>\r\n\r\n                            {importStatus && (\r\n                                <div className={`${styles.messageBox} ${importStatus.includes('خطأ') ? styles.errorMsg : styles.successMsg}`} style={{ marginTop: '2rem' }}>\r\n                                    {importStatus}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            <style jsx global>{`\r\n                @media print {\r\n                    .no-print { display: none !important; }\r\n                    /* Force layoutreset for full width printing */\r\n                    body { margin: 0; padding: 0; background: white; }\r\n                    @page { size: landscape; margin: 0.5cm; }\r\n                    \r\n                    /* If we want full width table in print */\r\n                    .${styles.container} { max-width: 100% !important; padding: 0 !important; }\r\n                    .${styles.tableWrapper} { width: 100%; border: none; }\r\n                }\r\n            `}</style>\r\n        </div>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}